<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Convert a survey design object to a replication design using Fay's generalized replication method — as_fays_gen_rep_design • svrep</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Convert a survey design object to a replication design using Fay's generalized replication method — as_fays_gen_rep_design"><meta name="description" content="Converts a survey design object to a replicate design object
with replicate weights formed using the generalized replication method of Fay (1989).
The generalized replication method forms replicate weights
from a textbook variance estimator, provided that the variance estimator
can be represented as a quadratic form whose matrix is positive semidefinite
(this covers a large class of variance estimators)."><meta property="og:description" content="Converts a survey design object to a replicate design object
with replicate weights formed using the generalized replication method of Fay (1989).
The generalized replication method forms replicate weights
from a textbook variance estimator, provided that the variance estimator
can be represented as a quadratic form whose matrix is positive semidefinite
(this covers a large class of variance estimators)."><meta property="og:image" content="https://bschneidr.github.io/svrep/logo.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">svrep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/bootstrap-replicates.html">Bootstrap Methods for Surveys</a></li>
    <li><a class="dropdown-item" href="../articles/nonresponse-adjustments.html">Nonresponse Adjustments</a></li>
    <li><a class="dropdown-item" href="../articles/sample-based-calibration.html">Calibrating to Estimated Control Totals</a></li>
    <li><a class="dropdown-item" href="../articles/two-phase-sampling.html">Replication Methods for Two-phase Sampling</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bschneidr/svrep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Convert a survey design object to a replication design using Fay's generalized replication method</h1>
      <small class="dont-index">Source: <a href="https://github.com/bschneidr/svrep/blob/main/R/fays_generalized_replication.R" class="external-link"><code>R/fays_generalized_replication.R</code></a></small>
      <div class="d-none name"><code>as_fays_gen_rep_design.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Converts a survey design object to a replicate design object
with replicate weights formed using the generalized replication method of Fay (1989).
The generalized replication method forms replicate weights
from a textbook variance estimator, provided that the variance estimator
can be represented as a quadratic form whose matrix is positive semidefinite
(this covers a large class of variance estimators).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">as_fays_gen_rep_design</span><span class="op">(</span></span>
<span>  <span class="va">design</span>,</span>
<span>  variance_estimator <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  aux_var_names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  max_replicates <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  balanced <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  psd_option <span class="op">=</span> <span class="st">"warn"</span>,</span>
<span>  mse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-design">design<a class="anchor" aria-label="anchor" href="#arg-design"></a></dt>
<dd><p>A survey design object created using the 'survey' (or 'srvyr') package,
with class <code>'survey.design'</code> or <code>'svyimputationList'</code>.</p></dd>


<dt id="arg-variance-estimator">variance_estimator<a class="anchor" aria-label="anchor" href="#arg-variance-estimator"></a></dt>
<dd><p>The name of the variance estimator
whose quadratic form matrix should be created.
See <a href="variance-estimators.html">variance-estimators</a> for a
detailed description of each variance estimator.
Options include:</p><ul><li><p><strong>"Yates-Grundy"</strong>: <br> The Yates-Grundy variance estimator based on
    first-order and second-order inclusion probabilities.</p></li>
<li><p><strong>"Horvitz-Thompson"</strong>: <br> The Horvitz-Thompson variance estimator based on
    first-order and second-order inclusion probabilities.</p></li>
<li><p><strong>"Poisson Horvitz-Thompson"</strong>: <br> The Horvitz-Thompson variance estimator
    based on assuming Poisson sampling, with first-order inclusion probabilities
    inferred from the sampling probabilities of the survey design object.</p></li>
<li><p><strong>"Stratified Multistage SRS"</strong>: <br> The usual stratified multistage variance estimator
    based on estimating the variance of cluster totals within strata at each stage.</p></li>
<li><p><strong>"Ultimate Cluster"</strong>: <br> The usual variance estimator based on estimating
    the variance of first-stage cluster totals within first-stage strata.</p></li>
<li><p><strong>"Deville-1"</strong>: <br> A variance estimator for unequal-probability
    sampling without replacement, described in Matei and Tillé (2005)
    as "Deville 1".</p></li>
<li><p><strong>"Deville-2"</strong>: <br> A variance estimator for unequal-probability
    sampling without replacement, described in Matei and Tillé (2005) as "Deville 2".</p></li>
<li><p><strong>"Deville-Tille": </strong> <br> A variance estimator useful
    for balanced sampling designs, proposed by Deville and Tillé (2005).</p></li>
<li><p><strong>"SD1"</strong>: <br> The non-circular successive-differences variance estimator described by Ash (2014),
    sometimes used for variance estimation for systematic sampling.</p></li>
<li><p><strong>"SD2"</strong>:  <br> The circular successive-differences variance estimator described by Ash (2014).
    This estimator is the basis of the "successive-differences replication" estimator commonly used
    for variance estimation for systematic sampling.</p></li>
<li><p><strong>"BOSB"</strong>: <br> The kernel-based variance estimator proposed by
    Breidt, Opsomer, and Sanchez-Borrego (2016) for use with systematic samples
    or other finely stratified designs. Uses the Epanechnikov kernel
    with the bandwidth automatically chosen to result in the smallest possible
    nonempty kernel window.</p></li>
<li><p><strong>"Beaumont-Emond"</strong>: <br> The variance estimator of Beaumont and Emond (2022)
    for multistage unequal-probability sampling without replacement.</p></li>
</ul></dd>


<dt id="arg-aux-var-names">aux_var_names<a class="anchor" aria-label="anchor" href="#arg-aux-var-names"></a></dt>
<dd><p>(Only used if <code>variance_estimator = "Deville-Tille")</code>.
A vector of the names of auxiliary variables used in sampling.</p></dd>


<dt id="arg-max-replicates">max_replicates<a class="anchor" aria-label="anchor" href="#arg-max-replicates"></a></dt>
<dd><p>The maximum number of replicates to allow (should be as large as possible, given computer memory/storage limitations).
A commonly-recommended default is 500. If the number of replicates needed
for a balanced, fully-efficient estimator is less than <code>max_replicates</code>,
then only the number of replicates needed will be created.
If more replicates are needed than <code>max_replicates</code>, then the full number of replicates
needed will be created, but only a random subsample will be retained.</p></dd>


<dt id="arg-balanced">balanced<a class="anchor" aria-label="anchor" href="#arg-balanced"></a></dt>
<dd><p>If <code>balanced=TRUE</code>, the replicates
will all contribute equally to variance estimates, but
the number of replicates needed may slightly increase.</p></dd>


<dt id="arg-psd-option">psd_option<a class="anchor" aria-label="anchor" href="#arg-psd-option"></a></dt>
<dd><p>Either <code>"warn"</code> (the default) or <code>"error"</code>.
This option specifies what will happen if the target variance estimator
has a quadratic form matrix which is not positive semidefinite. This
can occasionally happen, particularly for two-phase designs. <br>
If <code>psd_option="error"</code>, then an error message will be displayed. <br>
If <code>psd_option="warn"</code>, then a warning message will be displayed,
and the quadratic form matrix will be approximated by the most similar
positive semidefinite matrix.
This approximation was suggested by Beaumont and Patak (2012),
who note that this is conservative in the sense of producing
overestimates of variance.
Beaumont and Patak (2012) argue that this overestimation is expected to be
small in magnitude. See <code><a href="get_nearest_psd_matrix.html">get_nearest_psd_matrix</a></code>
for details of the approximation.</p></dd>


<dt id="arg-mse">mse<a class="anchor" aria-label="anchor" href="#arg-mse"></a></dt>
<dd><p>If <code>TRUE</code> (the default), compute variances from sums of squares around the point estimate from the full-sample weights.
If <code>FALSE</code>, compute variances from sums of squares around the mean estimate from the replicate weights.
For Fay's generalized replication method, setting <code>mse = FALSE</code> can potentially
lead to large underestimates of variance.</p></dd>


<dt id="arg-compress">compress<a class="anchor" aria-label="anchor" href="#arg-compress"></a></dt>
<dd><p>This reduces the computer memory required to represent the replicate weights and has no
impact on estimates.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A replicate design object, with class <code>svyrep.design</code>, which can be used with the usual functions,
such as <code><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean()</a></code> or <code><a href="https://rdrr.io/pkg/survey/man/svyglm.html" class="external-link">svyglm()</a></code>.</p>
<p>Use <code>weights(..., type = 'analysis')</code> to extract the matrix of replicate weights.</p>
<p>Use <code><a href="as_data_frame_with_weights.html">as_data_frame_with_weights()</a></code> to convert the design object to a data frame with columns
for the full-sample and replicate weights.</p>
    </div>
    <div class="section level2">
    <h2 id="statistical-details">Statistical Details<a class="anchor" aria-label="anchor" href="#statistical-details"></a></h2>


<p>See Fay (1989) for a full description of this replication method,
or see the documentation in <a href="make_fays_gen_rep_factors.html">make_fays_gen_rep_factors</a> for implementation details.</p>
<p>See <a href="variance-estimators.html">variance-estimators</a> for a
description of each variance estimator available for use with
this function.</p>
<p>Use <code><a href="rescale_reps.html">rescale_reps</a></code> to eliminate negative adjustment factors.</p>
    </div>
    <div class="section level2">
    <h2 id="two-phase-designs">Two-Phase Designs<a class="anchor" aria-label="anchor" href="#two-phase-designs"></a></h2>


<p>For a two-phase design, <code>variance_estimator</code> should be a list of variance estimators' names,
with two elements, such as <code>list('Ultimate Cluster', 'Poisson Horvitz-Thompson')</code>.
In two-phase designs, only the following estimators may be used for the second phase:</p><ul><li><p>"Ultimate Cluster"</p></li>
<li><p>"Stratified Multistage SRS"</p></li>
<li><p>"Poisson Horvitz-Thompson"</p></li>
</ul><p>For statistical details on the handling of two-phase designs,
see the documentation for <a href="make_twophase_quad_form.html">make_twophase_quad_form</a>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>The generalized replication method was first proposed in
Fay (1984). Fay (1989) refined the generalized replication method
to produce "balanced" replicates, in the sense that
each replicate contributes equally to variance estimates.
The advantage of balanced replicates is that one can
still obtain a reasonable variance estimate
by using only a random subset of the replicates.</p>
<p>- Ash, S. (2014). "<em>Using successive difference replication for estimating variances</em>."
<strong>Survey Methodology</strong>, Statistics Canada, 40(1), 47-59.
<br><br>
- Beaumont, J.-F.; Émond, N. (2022).
"<em>A Bootstrap Variance Estimation Method for Multistage Sampling and Two-Phase Sampling When Poisson Sampling Is Used at the Second Phase</em>."
<strong>Stats</strong>, <em>5</em>: 339-357.
https://doi.org/10.3390/stats5020019
<br><br>
- Breidt, F. J., Opsomer, J. D., &amp; Sanchez-Borrego, I. (2016).
"<em>Nonparametric Variance Estimation Under Fine Stratification: An Alternative to Collapsed Strata</em>."
<strong>Journal of the American Statistical Association</strong>, 111(514), 822-833. https://doi.org/10.1080/01621459.2015.1058264
<br><br>
- Deville, J. C., and Tillé, Y. (2005). "<em>Variance approximation under balanced sampling.</em>"
<strong>Journal of Statistical Planning and Inference</strong>, 128, 569-591.
<br><br>
- Dippo, Cathryn, Robert Fay, and David Morganstein. 1984. "Computing Variances from Complex Samples with Replicate Weights." In, 489-94. Alexandria, VA: American Statistical Association. http://www.asasrms.org/Proceedings/papers/1984_094.pdf.
<br><br>
- Fay, Robert. 1984. "Some Properties of Estimates of Variance Based on Replication Methods." In, 495-500. Alexandria, VA: American Statistical Association. http://www.asasrms.org/Proceedings/papers/1984_095.pdf.
<br><br>
- Fay, Robert. 1989. "Theory And Application Of Replicate Weighting For Variance Calculations." In, 495-500. Alexandria, VA: American Statistical Association. http://www.asasrms.org/Proceedings/papers/1989_033.pdf
<br><br>
- Matei, Alina, and Yves Tillé. (2005).
"<em>Evaluation of Variance Approximations and Estimators
in Maximum Entropy Sampling with Unequal Probability and Fixed Sample Size.</em>"
<strong>Journal of Official Statistics</strong>, 21(4):543-70.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>For greater customization of the method, <code><a href="make_quad_form_matrix.html">make_quad_form_matrix</a></code> can be used to
represent several common variance estimators as a quadratic form's matrix,
which can then be used as an input to <code><a href="make_fays_gen_rep_factors.html">make_fays_gen_rep_factors</a></code>.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">## Load an example systematic sample ----</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">## First, ensure data are sorted in same order as was used in sampling</span></span></span>
<span class="r-in"><span>  <span class="va">library_stsys_sample</span> <span class="op">&lt;-</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/sort_by.html" class="external-link">sort_by</a></span><span class="op">(</span><span class="op">~</span> <span class="va">SAMPLING_SORT_ORDER</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">## Create a survey design object</span></span></span>
<span class="r-in"><span>  <span class="va">design_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">library_stsys_sample</span>,</span></span>
<span class="r-in"><span>    strata <span class="op">=</span> <span class="op">~</span> <span class="va">SAMPLING_STRATUM</span>,</span></span>
<span class="r-in"><span>    ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>    fpc <span class="op">=</span> <span class="op">~</span> <span class="va">STRATUM_POP_SIZE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">## Convert to generalized replicate design</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">gen_rep_design_sd2</span> <span class="op">&lt;-</span> <span class="fu">as_fays_gen_rep_design</span><span class="op">(</span></span></span>
<span class="r-in"><span>    design <span class="op">=</span> <span class="va">design_obj</span>,</span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"SD2"</span>,</span></span>
<span class="r-in"><span>    max_replicates <span class="op">=</span> <span class="fl">250</span>,</span></span>
<span class="r-in"><span>    mse <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTSTAFF</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">gen_rep_design_sd2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Schneider.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

