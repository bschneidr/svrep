<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Get Variance Estimator's Quadratic Form Matrix — make_quad_form_matrix • svrep</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get Variance Estimator's Quadratic Form Matrix — make_quad_form_matrix"><meta name="description" content="Common variance estimators for estimated population totals can be represented as a quadratic form.
Given a choice of variance estimator and information about the sample design,
this function constructs the matrix of the quadratic form.

In notation, let
\(v(\hat{Y}) = \mathbf{\breve{y}}^{\prime}\mathbf{\Sigma}\mathbf{\breve{y}}\),
where \(\breve{y}\) is the vector of weighted values, \(y_i/\pi_i, \space i=1,\dots,n\).
This function constructs the \(n \times n\) matrix of the quadratic form, \(\mathbf{\Sigma}\)."><meta property="og:description" content="Common variance estimators for estimated population totals can be represented as a quadratic form.
Given a choice of variance estimator and information about the sample design,
this function constructs the matrix of the quadratic form.

In notation, let
\(v(\hat{Y}) = \mathbf{\breve{y}}^{\prime}\mathbf{\Sigma}\mathbf{\breve{y}}\),
where \(\breve{y}\) is the vector of weighted values, \(y_i/\pi_i, \space i=1,\dots,n\).
This function constructs the \(n \times n\) matrix of the quadratic form, \(\mathbf{\Sigma}\)."><meta property="og:image" content="https://bschneidr.github.io/svrep/logo.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">svrep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/bootstrap-replicates.html">Bootstrap Methods for Surveys</a></li>
    <li><a class="dropdown-item" href="../articles/nonresponse-adjustments.html">Nonresponse Adjustments</a></li>
    <li><a class="dropdown-item" href="../articles/sample-based-calibration.html">Calibrating to Estimated Control Totals</a></li>
    <li><a class="dropdown-item" href="../articles/two-phase-sampling.html">Replication Methods for Two-phase Sampling</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bschneidr/svrep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Get Variance Estimator's Quadratic Form Matrix</h1>
      <small class="dont-index">Source: <a href="https://github.com/bschneidr/svrep/blob/main/R/quadratic_forms.R" class="external-link"><code>R/quadratic_forms.R</code></a></small>
      <div class="d-none name"><code>make_quad_form_matrix.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Common variance estimators for estimated population totals can be represented as a quadratic form.
Given a choice of variance estimator and information about the sample design,
this function constructs the matrix of the quadratic form.
<br><br>
In notation, let
\(v(\hat{Y}) = \mathbf{\breve{y}}^{\prime}\mathbf{\Sigma}\mathbf{\breve{y}}\),
where \(\breve{y}\) is the vector of weighted values, \(y_i/\pi_i, \space i=1,\dots,n\).
This function constructs the \(n \times n\) matrix of the quadratic form, \(\mathbf{\Sigma}\).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">make_quad_form_matrix</span><span class="op">(</span></span>
<span>  variance_estimator <span class="op">=</span> <span class="st">"Yates-Grundy"</span>,</span>
<span>  probs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  joint_probs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  cluster_ids <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  strata_ids <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  strata_pop_sizes <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sort_order <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  aux_vars <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-variance-estimator">variance_estimator<a class="anchor" aria-label="anchor" href="#arg-variance-estimator"></a></dt>
<dd><p>The name of the variance estimator
whose quadratic form matrix should be created. See the section "Variance Estimators" below.
Options include:</p><ul><li><p><strong>"Yates-Grundy"</strong>: The Yates-Grundy variance estimator based on
first-order and second-order inclusion probabilities. If this is used,
the argument <code>joint_probs</code> must also be used.</p></li>
<li><p><strong>"Horvitz-Thompson"</strong>: The Horvitz-Thompson variance estimator based on
first-order and second-order inclusion probabilities. If this is used,
the argument <code>joint_probs</code> must also be used.</p></li>
<li><p><strong>"Stratified Multistage SRS"</strong>: The usual stratified multistage variance estimator
based on estimating the variance of cluster totals within strata at each stage.
If this option is used, then it is necessary to also use the arguments
<code>strata_ids</code>, <code>cluster_ids</code>, <code>strata_pop_sizes</code>, and <code>strata_pop_sizes</code>.</p></li>
<li><p><strong>"Ultimate Cluster"</strong>: The usual variance estimator based on estimating
the variance of first-stage cluster totals within first-stage strata.
If this option is used, then it is necessary to also use the arguments
<code>strata_ids</code>, <code>cluster_ids</code>, <code>strata_pop_sizes</code>.
Optionally, to use finite population correction factors, one can also use the argument <code>strata_pop_sizes</code>.</p></li>
<li><p><strong>"Deville-1"</strong>: A variance estimator for unequal-probability
sampling without replacement, described in Matei and Tillé (2005)
as "Deville 1". If this option is used, then it is necessary to also use the arguments
<code>strata_ids</code>, <code>cluster_ids</code>, and <code>probs</code>.</p></li>
<li><p><strong>"Deville-2"</strong>:  A variance estimator for unequal-probability
sampling without replacement, described in Matei and Tillé (2005)
as "Deville 2". If this option is used, then it is necessary to also use the arguments
<code>strata_ids</code>, <code>cluster_ids</code>, and <code>probs</code>.</p></li>
<li><p><strong>"SD1"</strong>: The non-circular successive-differences variance estimator described by Ash (2014),
sometimes used for variance estimation for systematic sampling.</p></li>
<li><p><strong>"SD2"</strong>: The circular successive-differences variance estimator described by Ash (2014).
This estimator is the basis of the "successive-differences replication" estimator commonly used
for variance estimation for systematic sampling.</p></li>
<li><p><strong>"BOSB"</strong>: <br> The kernel-based variance estimator proposed by
Breidt, Opsomer, and Sanchez-Borrego (2016) for use with systematic samples
or other finely stratified designs. Uses the Epanechnikov kernel
with the bandwidth automatically chosen to result in the smallest possible
nonempty kernel window.</p></li>
<li><p><strong>"Deville-Tille"</strong>: The estimator of Deville and Tillé (2005),
developed for balanced sampling using the cube method.</p></li>
<li><p><strong>"Beaumont-Emond"</strong>: The variance estimator of Beaumont and Emond (2022)
for multistage unequal-probability sampling without replacement.</p></li>
</ul></dd>


<dt id="arg-probs">probs<a class="anchor" aria-label="anchor" href="#arg-probs"></a></dt>
<dd><p>Required if <code>variance_estimator</code> equals <code>"Deville-1"</code>, <code>"Deville-2"</code>, or <code>"Deville-Tille"</code>.
This should be a matrix or data frame of sampling probabilities.
If there are multiple stages of sampling,
then <code>probs</code> can have multiple columns,
with one column for each level of sampling to be accounted for by the variance estimator.</p></dd>


<dt id="arg-joint-probs">joint_probs<a class="anchor" aria-label="anchor" href="#arg-joint-probs"></a></dt>
<dd><p>Only used if <code>variance_estimator = "Horvitz-Thompson"</code> or <code>variance_estimator = "Yates-Grundy"</code>.
This should be a matrix of joint inclusion probabilities.
Element <code>[i,i]</code> of the matrix is the first-order inclusion probability of unit <code>i</code>,
while element <code>[i,j]</code> is the joint inclusion probability of units <code>i</code> and <code>j</code>.</p></dd>


<dt id="arg-cluster-ids">cluster_ids<a class="anchor" aria-label="anchor" href="#arg-cluster-ids"></a></dt>
<dd><p>Required unless <code>variance_estimator</code> equals <code>"Horvitz-Thompson"</code> or <code>"Yates-Grundy"</code>.
This should be a matrix or data frame of cluster IDs. If there are multiple stages of sampling,
then <code>cluster_ids</code> can have multiple columns,
with one column for each level of sampling to be accounted for by the variance estimator.</p></dd>


<dt id="arg-strata-ids">strata_ids<a class="anchor" aria-label="anchor" href="#arg-strata-ids"></a></dt>
<dd><p>Required if <code>variance_estimator</code> equals <code>"Stratified Multistage SRS"</code>
or <code>"Ultimate Cluster"</code>.
This should be a matrix or data frame of strata IDs. If there are multiple stages of sampling,
then <code>strata_ids</code> can have multiple columns,
with one column for each level of sampling to be accounted for by the variance estimator.</p></dd>


<dt id="arg-strata-pop-sizes">strata_pop_sizes<a class="anchor" aria-label="anchor" href="#arg-strata-pop-sizes"></a></dt>
<dd><p>Required if <code>variance_estimator</code> equals <code>"Stratified Multistage SRS"</code>,
but can optionally be used if <code>variance_estimator</code> equals <code>"Ultimate Cluster"</code>, <code>"SD1"</code>, or <code>"SD2"</code>.
If there are multiple stages of sampling,
then <code>strata_pop_sizes</code> can have multiple columns,
with one column for each level of sampling to be accounted for by the variance estimator.</p></dd>


<dt id="arg-sort-order">sort_order<a class="anchor" aria-label="anchor" href="#arg-sort-order"></a></dt>
<dd><p>Required if <code>variance_estimator</code> equals <code>"SD1"</code> or <code>"SD2"</code>.
This should be a vector that orders the rows of data into the order used for sampling.</p></dd>


<dt id="arg-aux-vars">aux_vars<a class="anchor" aria-label="anchor" href="#arg-aux-vars"></a></dt>
<dd><p>Required if <code>variance_estimator</code> equals <code>"Deville-Tille"</code>.
A matrix of auxiliary variables.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The matrix of the quadratic form representing the variance estimator.</p>
    </div>
    <div class="section level2">
    <h2 id="variance-estimators">Variance Estimators<a class="anchor" aria-label="anchor" href="#variance-estimators"></a></h2>


<p>See <a href="variance-estimators.html">variance-estimators</a> for a
description of each variance estimator.</p>
    </div>
    <div class="section level2">
    <h2 id="arguments-required-for-each-variance-estimator">Arguments required for each variance estimator<a class="anchor" aria-label="anchor" href="#arguments-required-for-each-variance-estimator"></a></h2>


<p>Below are the arguments that are required or optional for each variance estimator.</p><table class="table table"><tr><td>variance_estimator</td><td>probs</td><td>joint_probs</td><td>cluster_ids</td><td>strata_ids</td><td>strata_pop_sizes</td><td>sort_order</td><td>aux_vars</td></tr><tr><td>Stratified Multistage SRS</td><td></td><td></td><td>Required</td><td>Required</td><td>Required</td><td></td><td></td></tr><tr><td>Ultimate Cluster</td><td></td><td></td><td>Required</td><td>Required</td><td>Optional</td><td></td><td></td></tr><tr><td>SD1</td><td></td><td></td><td>Required</td><td>Optional</td><td>Optional</td><td>Required</td><td></td></tr><tr><td>SD2</td><td></td><td></td><td>Required</td><td>Optional</td><td>Optional</td><td>Required</td><td></td></tr><tr><td>Deville-1</td><td>Required</td><td></td><td>Required</td><td>Optional</td><td></td><td></td><td></td></tr><tr><td>Deville-2</td><td>Required</td><td></td><td>Required</td><td>Optional</td><td></td><td></td><td></td></tr><tr><td>Beaumont-Emond</td><td>Required</td><td></td><td>Required</td><td>Optional</td><td></td><td></td><td></td></tr><tr><td>Deville-Tille</td><td>Required</td><td></td><td>Required</td><td>Optional</td><td></td><td></td><td>Required</td></tr><tr><td>BOSB</td><td></td><td></td><td>Required</td><td>Optional</td><td></td><td></td><td>Required</td></tr><tr><td>Yates-Grundy</td><td></td><td>Required</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Horvitz-Thompson</td><td></td><td>Required</td><td></td><td></td><td></td><td></td><td></td></tr></table></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>See <a href="variance-estimators.html">variance-estimators</a> for a
description of each variance estimator.</p>
<p>For a two-phase design, the function
<a href="make_twophase_quad_form.html">make_twophase_quad_form</a> combines
the quadratic form matrix from each phase.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Example 1: The Horvitz-Thompson Estimator</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"election"</span>, package <span class="op">=</span> <span class="st">"survey"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">ht_quad_form_matrix</span> <span class="op">&lt;-</span> <span class="fu">make_quad_form_matrix</span><span class="op">(</span>variance_estimator <span class="op">=</span> <span class="st">"Horvitz-Thompson"</span>,</span></span>
<span class="r-in"><span>                                               joint_probs <span class="op">=</span> <span class="va">election_jointprob</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co">##_ Produce variance estimate</span></span></span>
<span class="r-in"><span>  <span class="va">wtd_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">election_pps</span><span class="op">$</span><span class="va">wt</span> <span class="op">*</span> <span class="va">election_pps</span><span class="op">$</span><span class="va">Bush</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">ht_quad_form_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">wtd_y</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 x 1 Matrix of class "dgeMatrix"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              [,1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 6.782923e+12</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">##_ Compare against result from 'survey' package</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">Bush</span>,</span></span>
<span class="r-in"><span>           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">election_pps</span>,</span></span>
<span class="r-in"><span>                              variance <span class="op">=</span> <span class="st">"HT"</span>,</span></span>
<span class="r-in"><span>                              pps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/HR.html" class="external-link">ppsmat</a></span><span class="op">(</span><span class="va">election_jointprob</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                              ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, fpc <span class="op">=</span> <span class="op">~</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              [,1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 6.782923e+12</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 2: Stratified multistage Sample ----</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"mu284"</span>, package <span class="op">=</span> <span class="st">'survey'</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">multistage_srswor_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mu284</span>,</span></span>
<span class="r-in"><span>                                        ids <span class="op">=</span> <span class="op">~</span> <span class="va">id1</span> <span class="op">+</span> <span class="va">id2</span>,</span></span>
<span class="r-in"><span>                                        fpc <span class="op">=</span> <span class="op">~</span> <span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">multistage_srs_quad_form</span> <span class="op">&lt;-</span> <span class="fu">make_quad_form_matrix</span><span class="op">(</span></span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"Stratified Multistage SRS"</span>,</span></span>
<span class="r-in"><span>    cluster_ids <span class="op">=</span> <span class="va">mu284</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'id1'</span>, <span class="st">'id2'</span><span class="op">)</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    strata_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mu284</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    strata_pop_sizes <span class="op">=</span> <span class="va">mu284</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'n1'</span>, <span class="st">'n2'</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">wtd_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">multistage_srswor_design</span><span class="op">)</span> <span class="op">*</span> <span class="va">mu284</span><span class="op">$</span><span class="va">y1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">multistage_srs_quad_form</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">wtd_y</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 x 1 Matrix of class "dgeMatrix"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         [,1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 5172234</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">##_ Compare against result from 'survey' package</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">y1</span>, design <span class="op">=</span> <span class="va">multistage_srswor_design</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         y1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> y1 5172234</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 3: Successive-differences estimator ----</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">sd1_quad_form</span> <span class="op">&lt;-</span> <span class="fu">make_quad_form_matrix</span><span class="op">(</span></span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">'SD1'</span>,</span></span>
<span class="r-in"><span>    cluster_ids <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'FSCSKEY'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    strata_ids <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'SAMPLING_STRATUM'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    strata_pop_sizes <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'STRATUM_POP_SIZE'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    sort_order <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[[</span><span class="st">'SAMPLING_SORT_ORDER'</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">wtd_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">library_stsys_sample</span><span class="op">[[</span><span class="st">'TOTCIR'</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span></span></span>
<span class="r-in"><span>                      <span class="va">library_stsys_sample</span><span class="op">$</span><span class="va">SAMPLING_PROB</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">wtd_y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">sd1_quad_form</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">wtd_y</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 x 1 Matrix of class "dgeMatrix"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              [,1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 2.217205e+17</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 4: Deville estimators ----</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_multistage_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="va">deville_quad_form</span> <span class="op">&lt;-</span> <span class="fu">make_quad_form_matrix</span><span class="op">(</span></span></span>
<span class="r-in"><span>     variance_estimator <span class="op">=</span> <span class="st">'Deville-1'</span>,</span></span>
<span class="r-in"><span>     cluster_ids <span class="op">=</span> <span class="va">library_multistage_sample</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PSU_ID"</span>, <span class="st">"SSU_ID"</span><span class="op">)</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>     strata_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">library_multistage_sample</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                        <span class="va">library_multistage_sample</span><span class="op">$</span><span class="va">PSU_ID</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     probs <span class="op">=</span> <span class="va">library_multistage_sample</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PSU_SAMPLING_PROB"</span>,</span></span>
<span class="r-in"><span>                                          <span class="st">"SSU_SAMPLING_PROB"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span> <span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Schneider.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

