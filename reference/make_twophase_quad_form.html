<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function combines quadratic forms from each phase of a two phase design,
so that the combined variance of the entire two-phase sampling design can be estimated."><title>Combine quadratic forms from each phase of a two phase design — make_twophase_quad_form • svrep</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combine quadratic forms from each phase of a two phase design — make_twophase_quad_form"><meta property="og:description" content="This function combines quadratic forms from each phase of a two phase design,
so that the combined variance of the entire two-phase sampling design can be estimated."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">svrep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/bootstrap-replicates.html">Bootstrap Methods for Surveys</a>
    <a class="dropdown-item" href="../articles/nonresponse-adjustments.html">Nonresponse Adjustments</a>
    <a class="dropdown-item" href="../articles/sample-based-calibration.html">Calibrating to Estimated Control Totals</a>
    <a class="dropdown-item" href="../articles/two-phase-sampling.html">Replication Methods for Two-phase Sampling</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bschneidr/svrep/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Combine quadratic forms from each phase of a two phase design</h1>
      <small class="dont-index">Source: <a href="https://github.com/bschneidr/svrep/blob/HEAD/R/quadratic_forms.R" class="external-link"><code>R/quadratic_forms.R</code></a></small>
      <div class="d-none name"><code>make_twophase_quad_form.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function combines quadratic forms from each phase of a two phase design,
so that the combined variance of the entire two-phase sampling design can be estimated.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">make_twophase_quad_form</span><span class="op">(</span></span>
<span>  <span class="va">sigma_1</span>,</span>
<span>  <span class="va">sigma_2</span>,</span>
<span>  <span class="va">phase_2_joint_probs</span>,</span>
<span>  ensure_psd <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>sigma_1</dt>
<dd><p>The quadratic form for the first phase variance estimator,
subsetted to only include cases selected in the phase two sample.</p></dd>


<dt>sigma_2</dt>
<dd><p>The quadratic form for the second phase variance estimator,
conditional on the selection of the first phase sample.</p></dd>


<dt>phase_2_joint_probs</dt>
<dd><p>The matrix of conditional joint
inclusion probabilities for the second phase, given the selected
first phase sample.</p></dd>


<dt>ensure_psd</dt>
<dd><p>If <code>TRUE</code> (the default), ensures
that the result is a positive semidefinite matrix. This
is necessary if the quadratic form is used as an input for
replication methods such as the generalized bootstrap.
For details, see the help section entitled
"Ensuring the Result is Positive Semidefinite".</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A quadratic form matrix that can be used to estimate
the sampling variance from a two-phase sample design.</p>
    </div>
    <div class="section level2">
    <h2 id="statistical-details">Statistical Details<a class="anchor" aria-label="anchor" href="#statistical-details"></a></h2>
    

<p>The two-phase variance estimator has a quadratic form matrix \(\boldsymbol{\Sigma}_{ab}\) given by:
$$
  \boldsymbol{\Sigma}_{ab} = {W}^{-1}_b(\boldsymbol{\Sigma}_{a^\prime} \circ D_b ){W}^{-1}_b + \boldsymbol{\Sigma}_b
$$
The first term estimates the variance contribution from the first phase of sampling,
while the second term estimates the variance contribution from the second phase of sampling. <br></p>
<p>The full quadratic form of the variance estimator is:
$$
  v(\hat{t_y}) = \breve{\breve{y^{'}}} \boldsymbol{\Sigma}_{ab} \breve{\breve{y}}
$$
where the weighted variable \(\breve{\breve{y}}_k = \frac{y_k}{\pi_{ak}\pi_{bk}}\),
is formed using the first phase inclusion probability, denoted \(\pi_{ak}\), and
the conditional second phase inclusion probability (given the selected first phase sample),
denoted \(\pi_{bk}\). <br></p>
<p>The notation for this estimator is as follows: <br></p><ul><li><p>\(n_a\) denotes the first phase sample size.</p></li>
<li><p>\(n_b\) denotes the second phase sample size.</p></li>
<li><p>\(\boldsymbol{\Sigma}_a\) denotes the matrix of dimension \(n_a \times n_a\)
representing the quadratic form for the variance estimator
used for the full first-phase design.</p></li>
<li><p>\(\boldsymbol{\Sigma}_{a^\prime}\) denotes the matrix of dimension \(n_b \times n_b\)
formed by subsetting the rows and columns of \(\boldsymbol{\Sigma}_a\) to only include
cases selected in the second-phase sample.</p></li>
<li><p>\(\boldsymbol{\Sigma}_{b}\) denotes
the matrix of dimension \(n_b \times n_b\) representing the Horvitz-Thompson
estimator of variance for the second-phase sample, conditional on the selected
first-phase sample.</p></li>
<li><p>\(\boldsymbol{D}_b\) denotes the \(n_b \times n_b\) matrix of weights formed by the inverses of
the second-phase joint inclusion probabilities, with element \(kl\) equal to \(\pi_{bkl}^{-1}\),
where \(\pi_{bkl}\) is the conditional probability that units \(k\) and \(l\) are included
in the second-phase sample, given the selected first-phase sample. Note that this
matrix will often not be positive semidefinite, and so the two-phase variance estimator
has a quadratic form which is not necessarily positive semidefinite.</p></li>
<li><p>\(\boldsymbol{W}_b\) denotes the diagonal \(n_b \times n_b\) matrix
whose \(k\)-th diagonal entry is the second-phase weight \(\pi_{bk}^{-1}\),
where \(\pi_{bk}\) is the conditional probability that unit \(k\)
is included in the second-phase sample, given the selected first-phase sample.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="ensuring-the-result-is-positive-semidefinite">Ensuring the Result is Positive Semidefinite<a class="anchor" aria-label="anchor" href="#ensuring-the-result-is-positive-semidefinite"></a></h2>
    

<p>Note that the matrix \((\boldsymbol{\Sigma}_{a^\prime} \circ D_b )\) may not be
positive semidefinite, since the matrix \(D_b\) is not guaranteed to be positive semidefinite.
If \((\boldsymbol{\Sigma}_{a^\prime} \circ D_b )\) is found not to be positive semidefinite,
then it is approximated by the nearest positive semidefinite matrix in the Frobenius norm,
using the method of Higham (1988). <br><br>
This approximation is discussed by Beaumont and Patak (2012) in the context
of forming replicate weights for two-phase samples. The authors argue that
this approximation should lead to only a small overestimation of variance. <br><br>
Since \((\boldsymbol{\Sigma}_{a^\prime} \circ D_b )\)
is a real, symmetric matrix, this is equivalent to "zeroing out" negative eigenvalues.
To be more precise, denote \(A=(\boldsymbol{\Sigma}_{a^\prime} \circ D_b )\).
Then we can form the spectral decomposition \(A=\Gamma \Lambda \Gamma^{\prime}\), where \(\Lambda\) is the diagonal matrix
whose entries are eigenvalues of \(A\). The method of Higham (1988)
is to  approximate
\(A\) with \(\tilde{A} = \Gamma \Lambda_{+} \Gamma^{\prime}\),
where the \(ii\)-th entry of \(\Lambda_{+}\) is \(\max(\Lambda_{ii}, 0)\).</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>See Section 7.5 of Tillé (2020) or Section 9.3 of Särndal, Swensson, and Wretman (1992)
for an overview of variance estimation for two-phase sampling. In the case where
the Horvitz-Thompson variance estimator is used for both phases, the method used in this function
is equivalent to equation (9.3.8) of Särndal, Swensson, and Wretman (1992)
and equation (7.7) of Tillé (2020). However, this function can be used
for any combination of first-phase and second-phase variance estimators,
provided that the joint inclusion probabilities from the second-phase design
are available and are all nonzero.
<br><br></p><ul><li><p>Beaumont, Jean-François, and Zdenek Patak. (2012). “On the Generalized Bootstrap for Sample Surveys with Special Attention to Poisson Sampling: Generalized Bootstrap for Sample Surveys.”
International Statistical Review 80 (1): 127–48.
<br><br></p></li>
<li><p>Higham, N. J. (1988). "<em>Computing a nearest symmetric positive semidefinite matrix.</em>" Linear Algebra and Its Applications, 103, 103–118.
<br><br></p></li>
<li><p>Särndal, C.-E., Swensson, B., &amp; Wretman, J. (1992). "<em>Model Assisted Survey Sampling</em>." Springer New York.
<br><br></p></li>
<li><p>Tillé, Y. (2020). "<em>Sampling and estimation from finite populations</em>." (I. Hekimi, Trans.). Wiley.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>For each phase of sampling, the function
<a href="make_quad_form_matrix.html">make_quad_form_matrix</a> can be used to create
the appropriate quadratic form matrix.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## ---------------------- Example 1 ------------------------##</span></span></span>
<span class="r-in"><span><span class="co">## First phase is a stratified multistage sample            ##</span></span></span>
<span class="r-in"><span><span class="co">## Second phase is a simple random sample                   ##</span></span></span>
<span class="r-in"><span><span class="co">##----------------------------------------------------------##</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_multistage_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load first-phase sample</span></span></span>
<span class="r-in"><span>  <span class="va">twophase_sample</span> <span class="op">&lt;-</span> <span class="va">library_multistage_sample</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Select second-phase sample</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">twophase_sample</span><span class="op">[[</span><span class="st">'SECOND_PHASE_SELECTION'</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sampling</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sampling/man/srswor.html" class="external-link">srswor</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    n <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>    N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">twophase_sample</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Declare survey design</span></span></span>
<span class="r-in"><span>  <span class="va">twophase_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/twophase.html" class="external-link">twophase</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    method <span class="op">=</span> <span class="st">"full"</span>,</span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">twophase_sample</span>,</span></span>
<span class="r-in"><span>    <span class="co"># Identify the subset of first-phase elements</span></span></span>
<span class="r-in"><span>    <span class="co"># which were selected into the second-phase sample</span></span></span>
<span class="r-in"><span>    subset <span class="op">=</span> <span class="op">~</span> <span class="va">SECOND_PHASE_SELECTION</span>,</span></span>
<span class="r-in"><span>    <span class="co"># Describe clusters, probabilities, and population sizes</span></span></span>
<span class="r-in"><span>    <span class="co"># at each phase of sampling</span></span></span>
<span class="r-in"><span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span> <span class="va">PSU_ID</span> <span class="op">+</span> <span class="va">SSU_ID</span>,</span></span>
<span class="r-in"><span>              <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span> <span class="va">PSU_SAMPLING_PROB</span> <span class="op">+</span> <span class="va">SSU_SAMPLING_PROB</span>,</span></span>
<span class="r-in"><span>                 <span class="cn">NULL</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    fpc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span> <span class="va">PSU_POP_SIZE</span> <span class="op">+</span> <span class="va">SSU_POP_SIZE</span>,</span></span>
<span class="r-in"><span>               <span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get quadratic form matrix for the first phase design</span></span></span>
<span class="r-in"><span>  <span class="va">first_phase_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_design_quad_form.html">get_design_quad_form</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    design <span class="op">=</span> <span class="va">twophase_design</span><span class="op">$</span><span class="va">phase1</span><span class="op">$</span><span class="va">full</span>,</span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"Stratified Multistage SRS"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Subset to only include cases sampled in second phase</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">first_phase_sigma</span> <span class="op">&lt;-</span> <span class="va">first_phase_sigma</span><span class="op">[</span><span class="va">twophase_design</span><span class="op">$</span><span class="va">subset</span>,</span></span>
<span class="r-in"><span>                                         <span class="va">twophase_design</span><span class="op">$</span><span class="va">subset</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get quadratic form matrix for the second-phase design</span></span></span>
<span class="r-in"><span>  <span class="va">second_phase_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_design_quad_form.html">get_design_quad_form</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    design <span class="op">=</span> <span class="va">twophase_design</span><span class="op">$</span><span class="va">phase2</span>,</span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"Ultimate Cluster"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get second-phase joint probabilities</span></span></span>
<span class="r-in"><span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">twophase_design</span><span class="op">$</span><span class="va">phase2</span><span class="op">$</span><span class="va">fpc</span><span class="op">$</span><span class="va">sampsize</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">twophase_design</span><span class="op">$</span><span class="va">phase2</span><span class="op">$</span><span class="va">fpc</span><span class="op">$</span><span class="va">popsize</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">second_phase_joint_probs</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                     nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">second_phase_joint_probs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="va">N</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get quadratic form for entire two-phase variance estimator</span></span></span>
<span class="r-in"><span>  <span class="va">twophase_quad_form</span> <span class="op">&lt;-</span> <span class="fu">make_twophase_quad_form</span><span class="op">(</span></span></span>
<span class="r-in"><span>   sigma_1 <span class="op">=</span> <span class="va">first_phase_sigma</span>,</span></span>
<span class="r-in"><span>   sigma_2 <span class="op">=</span> <span class="va">second_phase_sigma</span>,</span></span>
<span class="r-in"><span>   phase_2_joint_probs <span class="op">=</span> <span class="va">second_phase_joint_probs</span></span></span>
<span class="r-in"><span> <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="co"># Use for variance estimation</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>   <span class="va">rep_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="make_gen_boot_factors.html">make_gen_boot_factors</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>     Sigma <span class="op">=</span> <span class="va">twophase_quad_form</span>,</span></span>
<span class="r-in"><span>     num_replicates <span class="op">=</span> <span class="fl">500</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>   <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>   <span class="va">combined_weights</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">twophase_design</span><span class="op">$</span><span class="va">prob</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>   <span class="va">twophase_rep_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>     data <span class="op">=</span> <span class="va">twophase_sample</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>       <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">SECOND_PHASE_SELECTION</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     type <span class="op">=</span> <span class="st">'other'</span>,</span></span>
<span class="r-in"><span>     repweights <span class="op">=</span> <span class="va">rep_factors</span>,</span></span>
<span class="r-in"><span>     weights <span class="op">=</span> <span class="va">combined_weights</span>,</span></span>
<span class="r-in"><span>     combined.weights <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>     scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_factors</span>, <span class="st">'scale'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     rscales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_factors</span>, <span class="st">'rscales'</span><span class="op">)</span></span></span>
<span class="r-in"><span>   <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">LIBRARIA</span>, design <span class="op">=</span> <span class="va">twophase_rep_design</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## ---------------------- Example 2 ------------------------##</span></span></span>
<span class="r-in"><span><span class="co">## First phase is a stratified systematic sample            ##</span></span></span>
<span class="r-in"><span><span class="co">## Second phase is nonresponse, modeled as Poisson sampling ##</span></span></span>
<span class="r-in"><span><span class="co">##----------------------------------------------------------##</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Determine quadratic form for full first-phase sample variance estimator</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">full_phase1_quad_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="make_quad_form_matrix.html">make_quad_form_matrix</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"SD2"</span>,</span></span>
<span class="r-in"><span>    cluster_ids <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'FSCSKEY'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    strata_ids <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'SAMPLING_STRATUM'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    strata_pop_sizes <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">[</span>,<span class="st">'STRATUM_POP_SIZE'</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    sort_order <span class="op">=</span> <span class="va">library_stsys_sample</span><span class="op">$</span><span class="va">SAMPLING_SORT_ORDER</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Identify cases included in phase two sample</span></span></span>
<span class="r-in"><span><span class="co"># (in this example, respondents)</span></span></span>
<span class="r-in"><span>  <span class="va">phase2_inclusion</span> <span class="op">&lt;-</span> <span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="va">library_stsys_sample</span><span class="op">$</span><span class="va">RESPONSE_STATUS</span> <span class="op">==</span> <span class="st">"Survey Respondent"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">phase2_sample</span> <span class="op">&lt;-</span> <span class="va">library_stsys_sample</span><span class="op">[</span><span class="va">phase2_inclusion</span>,<span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Estimate response propensities</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">response_propensities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">library_stsys_sample</span>,</span></span>
<span class="r-in"><span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">quasibinomial</a></span><span class="op">(</span><span class="st">'logit'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    formula <span class="op">=</span> <span class="va">phase2_inclusion</span> <span class="op">~</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>    weights <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">library_stsys_sample</span><span class="op">$</span><span class="va">SAMPLING_PROB</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span>,</span></span>
<span class="r-in"><span>            newdata <span class="op">=</span> <span class="va">phase2_sample</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Estimate conditional joint inclusion probabilities for second phase</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">phase2_joint_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">response_propensities</span>, <span class="va">response_propensities</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">phase2_joint_probs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">response_propensities</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Determine quadratic form for variance estimator of second phase</span></span></span>
<span class="r-in"><span><span class="co"># (Horvitz-Thompson estimator for nonresponse modeled as Poisson sampling)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">phase2_quad_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="make_quad_form_matrix.html">make_quad_form_matrix</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    variance_estimator <span class="op">=</span> <span class="st">"Horvitz-Thompson"</span>,</span></span>
<span class="r-in"><span>    joint_probs <span class="op">=</span> <span class="va">phase2_joint_probs</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create combined quadratic form for entire design</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="va">twophase_quad_form</span> <span class="op">&lt;-</span> <span class="fu">make_twophase_quad_form</span><span class="op">(</span></span></span>
<span class="r-in"><span>   sigma_1 <span class="op">=</span> <span class="va">full_phase1_quad_form</span><span class="op">[</span><span class="va">phase2_inclusion</span>, <span class="va">phase2_inclusion</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>   sigma_2 <span class="op">=</span> <span class="va">phase2_quad_form</span>,</span></span>
<span class="r-in"><span>   phase_2_joint_probs <span class="op">=</span> <span class="va">phase2_joint_probs</span></span></span>
<span class="r-in"><span> <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span> <span class="va">combined_weights</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">phase2_sample</span><span class="op">$</span><span class="va">SAMPLING_PROB</span> <span class="op">*</span> <span class="va">response_propensities</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use for variance estimation</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">rep_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="make_gen_boot_factors.html">make_gen_boot_factors</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    Sigma <span class="op">=</span> <span class="va">twophase_quad_form</span>,</span></span>
<span class="r-in"><span>    num_replicates <span class="op">=</span> <span class="fl">500</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">twophase_rep_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">phase2_sample</span>,</span></span>
<span class="r-in"><span>    type <span class="op">=</span> <span class="st">'other'</span>,</span></span>
<span class="r-in"><span>    repweights <span class="op">=</span> <span class="va">rep_factors</span>,</span></span>
<span class="r-in"><span>    weights <span class="op">=</span> <span class="va">combined_weights</span>,</span></span>
<span class="r-in"><span>    combined.weights <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>    scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_factors</span>, <span class="st">'scale'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    rscales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_factors</span>, <span class="st">'rscales'</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">LIBRARIA</span>, design <span class="op">=</span> <span class="va">twophase_rep_design</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Ben Schneider.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

