<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="svrep">
<title>Calibrating to Estimated Control Totals • svrep</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibrating to Estimated Control Totals">
<meta property="og:description" content="svrep">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">svrep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/bootstrap-replicates.html">Bootstrap Methods for Surveys</a>
    <a class="dropdown-item" href="../articles/nonresponse-adjustments.html">Nonresponse Adjustments</a>
    <a class="dropdown-item" href="../articles/sample-based-calibration.html">Calibrating to Estimated Control Totals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bschneidr/svrep/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calibrating to Estimated Control Totals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bschneidr/svrep/blob/HEAD/vignettes/sample-based-calibration.Rmd" class="external-link"><code>vignettes/sample-based-calibration.Rmd</code></a></small>
      <div class="d-none name"><code>sample-based-calibration.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="sample-based-calibration-an-introduction">Sample-based Calibration: An Introduction<a class="anchor" aria-label="anchor" href="#sample-based-calibration-an-introduction"></a>
</h3>
<p>Calibration weighting adjustments such as post-stratification or
raking are often helpful for reducing sampling variance or non-sampling
errors such as nonresponse bias. Typically, the benchmark data used for
these calibration adjustments are estimates published by agencies such
as the United States Census Bureau. For example, pollsters in the United
States frequently rake polling data so that estimates for variables such
as age or educational attainment match benchmark estimates from the
American Community Survey (ACS).</p>
<p>While benchmark data (also known as control totals) for raking and
calibration are often treated as the “true” population values, they are
usually themselves estimates with their own sampling variance or margin
of error. When we calibrate to estimated control totals rather than to
“true” population values, we may need to account for the variance of the
estimated control totals to ensure that calibrated estimates
appropriately reflect sampling error of both the primary survey of
interest and the survey from which the control totals were estimated.
This is especially important if the control totals have large margins of
error.</p>
<p>A handful of statistical methods have been developed for the problem
of conducting replication variance estimation after sample-based
calibration; see <span class="citation">Opsomer and Erciulescu
(2021)</span> for a clear overview of the literature on this topic. All
of these methods apply calibration weighting adjustment to full-sample
weights and to each column of replicate weights. The key “trick” of
these methods is to adjust each column of replicate weights to a
slightly different set of control totals, varying the control totals
used across all of the replicates in such a way that the variation
across the columns is in a sense proportionate to the sampling variance
of the control totals.</p>
<p>These statistical methods differ in the way that they generate
different control totals for each column of replicate weights and in the
type of data they require the analyst to use. The method of <span class="citation">Fuller (1998)</span> requires the analyst to have a
variance-covariance matrix for the estimated control totals, while the
method of <span class="citation">Opsomer and Erciulescu (2021)</span>
requires the analyst to use the full dataset for the control survey
along with associated replicate weights.</p>
</div>
<div class="section level3">
<h3 id="functions-for-implementing-sample-based-calibration">Functions for Implementing Sample-Based Calibration<a class="anchor" aria-label="anchor" href="#functions-for-implementing-sample-based-calibration"></a>
</h3>
<p>The ‘svrep’ package provides two functions to implement sample-based
calibration.</p>
<p>With the function <code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code>, adjustments
to replicate weights are conducted using the method of Fuller (1998),
requiring a variance-covariance matrix for the estimated control
totals.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate</a></span><span class="op">(</span></span>
<span>  rep_design <span class="op">=</span> <span class="va">rep_design</span>,</span>
<span>  estimate <span class="op">=</span> <span class="va">vector_of_control_totals</span>,</span>
<span>  vcov_estimate <span class="op">=</span> <span class="va">variance_covariance_matrix_for_controls</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">CALIBRATION_VARIABLE_1</span> <span class="op">+</span> <span class="va">CALIBRATION_VARIABLE_2</span> <span class="op">+</span> <span class="va">...</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>With the function <code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code>, adjustments to
replicate weights are conducted using the method proposed by Opsomer and
Erciulescu (2021), requiring a dataset with replicate weights to use for
estimating control totals and their sampling variance.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calibrate_to_sample</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_rep_design =</span> primary_rep_design,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">control_rep_design =</span> control_rep_design</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cal_formula =</span> <span class="sc">~</span> CALIBRATION_VARIABLE_1 <span class="sc">+</span> CALIBRATION_VARIABLE_2 <span class="sc">+</span> ...,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>For both functions, it is possible to use a variety of calibration
options from the <code>survey</code> package’s <code><a href="https://rdrr.io/pkg/survey/man/calibrate.html" class="external-link">calibrate()</a></code>
function. For example, the user can specify a specific calibration
function to use, such as <code>calfun = survey::cal.linear</code> to
implement post-stratification or
<code>calfun = survey::cal.raking</code> to implement raking. The
<code>bounds</code> argument can be used to specify bounds for the
calibration weights, and the arguments such as <code>maxit</code> or
<code>epsilon</code> allow finer control over the Newton-Raphson
algorithm used to implement calibration.</p>
</div>
<div class="section level3">
<h3 id="an-example-using-a-vaccination-survey">An Example Using a Vaccination Survey<a class="anchor" aria-label="anchor" href="#an-example-using-a-vaccination-survey"></a>
</h3>
<p>To illustrate the different methods for conducting sample-based
calibration, we’ll use an example survey measuring Covid-19 vaccination
status and a handful of demographic variables, based on a simple random
sample of 1,000 residents of Louisville, Kentucky.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bschneidr.github.io/svrep/">svrep</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lou_vax_survey"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the first few rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lou_vax_survey</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="12%">
<col width="43%">
<col width="5%">
<col width="17%">
<col width="8%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">RESPONSE_STATUS</th>
<th align="left">RACE_ETHNICITY</th>
<th align="left">SEX</th>
<th align="left">EDUC_ATTAINMENT</th>
<th align="left">VAX_STATUS</th>
<th align="right">SAMPLING_WEIGHT</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Nonrespondent</td>
<td align="left">White alone, not Hispanic or Latino</td>
<td align="left">Female</td>
<td align="left">Less than high school</td>
<td align="left">NA</td>
<td align="right">596.702</td>
</tr>
<tr class="even">
<td align="left">Nonrespondent</td>
<td align="left">Black or African American alone, not Hispanic or
Latino</td>
<td align="left">Female</td>
<td align="left">High school or beyond</td>
<td align="left">NA</td>
<td align="right">596.702</td>
</tr>
<tr class="odd">
<td align="left">Respondent</td>
<td align="left">White alone, not Hispanic or Latino</td>
<td align="left">Female</td>
<td align="left">Less than high school</td>
<td align="left">Vaccinated</td>
<td align="right">596.702</td>
</tr>
<tr class="even">
<td align="left">Nonrespondent</td>
<td align="left">White alone, not Hispanic or Latino</td>
<td align="left">Female</td>
<td align="left">Less than high school</td>
<td align="left">NA</td>
<td align="right">596.702</td>
</tr>
<tr class="odd">
<td align="left">Nonrespondent</td>
<td align="left">White alone, not Hispanic or Latino</td>
<td align="left">Female</td>
<td align="left">High school or beyond</td>
<td align="left">NA</td>
<td align="right">596.702</td>
</tr>
<tr class="even">
<td align="left">Respondent</td>
<td align="left">White alone, not Hispanic or Latino</td>
<td align="left">Female</td>
<td align="left">High school or beyond</td>
<td align="left">Vaccinated</td>
<td align="right">596.702</td>
</tr>
</tbody>
</table>
<p>For the purpose of variance estimation, we’ll create jackknife
replicate weights.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lou_vax_survey_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">lou_vax_survey</span>,</span>
<span>  ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, weights <span class="op">=</span> <span class="op">~</span> <span class="va">SAMPLING_WEIGHT</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/as.svrepdesign.html" class="external-link">as.svrepdesign</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"JK1"</span>, mse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Call: as.svrepdesign.default(svydesign(data = lou_vax_survey, ids = ~1, </span></span>
<span><span class="co">#&gt;     weights = ~SAMPLING_WEIGHT), type = "JK1", mse = TRUE)</span></span>
<span><span class="co">#&gt; Unstratified cluster jacknife (JK1) with 1000 replicates and MSE variances.</span></span></code></pre>
<p>Because the survey’s key outcome, vaccination status, is only
measured for respondents, we’ll do a quick nonresponse weighting
adjustment to help make reasonable estimates for this outcome.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Conduct nonresponse weighting adjustment</span></span>
<span></span>
<span><span class="va">nr_adjusted_design</span> <span class="op">&lt;-</span> <span class="va">lou_vax_survey_rep</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/redistribute_weights.html">redistribute_weights</a></span><span class="op">(</span></span>
<span>    reduce_if <span class="op">=</span> <span class="va">RESPONSE_STATUS</span> <span class="op">==</span> <span class="st">"Nonrespondent"</span>,</span>
<span>    increase_if <span class="op">=</span> <span class="va">RESPONSE_STATUS</span> <span class="op">==</span> <span class="st">"Respondent"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">RESPONSE_STATUS</span> <span class="op">==</span> <span class="st">"Respondent"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the result of the adjustment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="st">'Original'</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarize_rep_weights.html">summarize_rep_weights</a></span><span class="op">(</span><span class="va">lou_vax_survey_rep</span>, type <span class="op">=</span> <span class="st">'overall'</span><span class="op">)</span>,</span>
<span>  <span class="st">'NR-adjusted'</span> <span class="op">=</span> <span class="fu"><a href="../reference/summarize_rep_weights.html">summarize_rep_weights</a></span><span class="op">(</span><span class="va">nr_adjusted_design</span>, type <span class="op">=</span> <span class="st">'overall'</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nrows"</span>, <span class="st">"rank"</span>, <span class="st">"avg_wgt_sum"</span>, <span class="st">"sd_wgt_sums"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;             nrows rank avg_wgt_sum  sd_wgt_sums</span></span>
<span><span class="co">#&gt; Original     1000 1000      596702 0.000000e+00</span></span>
<span><span class="co">#&gt; NR-adjusted   502  502      596702 8.219437e-11</span></span></code></pre></div>
<p>All of the work so far has given us the replicate design for the
primary survey, prepared for calibration. Now we need to obtain
benchmark data we can use for the calibration. We’ll use a Public-Use
Microdata Sample (PUMS) dataset from the ACS as our source for benchmark
data on race/ethnicity, sex, and educational attainment.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lou_pums_microdata"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect some of the rows/columns of data ----</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">lou_pums_microdata</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">AGE</span>, <span class="va">SEX</span>, <span class="va">RACE_ETHNICITY</span>, <span class="va">EDUC_ATTAINMENT</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="5%">
<col width="10%">
<col width="51%">
<col width="32%">
</colgroup>
<thead><tr class="header">
<th align="right">AGE</th>
<th align="left">SEX</th>
<th align="left">RACE_ETHNICITY</th>
<th align="left">EDUC_ATTAINMENT</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">20</td>
<td align="left">Female</td>
<td align="left">Other Race, not Hispanic or Latino</td>
<td align="left">High school or beyond</td>
</tr>
<tr class="even">
<td align="right">50</td>
<td align="left">Male</td>
<td align="left">Hispanic or Latino</td>
<td align="left">Less than high school</td>
</tr>
<tr class="odd">
<td align="right">57</td>
<td align="left">Female</td>
<td align="left">Other Race, not Hispanic or Latino</td>
<td align="left">High school or beyond</td>
</tr>
<tr class="even">
<td align="right">44</td>
<td align="left">Male</td>
<td align="left">Hispanic or Latino</td>
<td align="left">High school or beyond</td>
</tr>
<tr class="odd">
<td align="right">25</td>
<td align="left">Female</td>
<td align="left">Hispanic or Latino</td>
<td align="left">High school or beyond</td>
</tr>
</tbody>
</table>
<p>Next, we’ll prepare the PUMS data to use replication variance
estimation using provided replicate weights.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert to a survey design object ----</span></span>
<span>  <span class="va">pums_rep_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">lou_pums_microdata</span>,</span>
<span>      weights <span class="op">=</span> <span class="op">~</span> <span class="va">PWGTP</span>,</span>
<span>      repweights <span class="op">=</span> <span class="st">"PWGTP\\d{1,2}"</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"successive-difference"</span>,</span>
<span>      variables <span class="op">=</span> <span class="op">~</span> <span class="va">AGE</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>      mse <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="va">pums_rep_design</span></span>
<span><span class="co">#&gt; Call: svrepdesign.default(data = lou_pums_microdata, weights = ~PWGTP, </span></span>
<span><span class="co">#&gt;     repweights = "PWGTP\\d{1,2}", type = "successive-difference", </span></span>
<span><span class="co">#&gt;     variables = ~AGE + SEX + RACE_ETHNICITY + EDUC_ATTAINMENT, </span></span>
<span><span class="co">#&gt;     mse = TRUE)</span></span>
<span><span class="co">#&gt; with 80 replicates and MSE variances.</span></span></code></pre></div>
<p>When conduction calibration, we have to make sure that the data from
the control survey represent the same population as the primary survey.
Since the Louisville vaccination survey only represents adults, we need
to subset the control survey design to adults.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Subset to only include adults</span></span>
<span><span class="va">pums_rep_design</span> <span class="op">&lt;-</span> <span class="va">pums_rep_design</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<p>In addition, we need to ensure that the control survey design has
calibration variables that align with the variables in the primary
survey design of interest. This may require some data manipulation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that variables match across data sources ----</span></span>
<span>  <span class="va">pums_rep_design</span><span class="op">$</span><span class="va">variables</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">RACE_ETHNICITY</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                            RACE_ETHNICITY</span></span>
<span><span class="co">#&gt; 1 Black or African American alone, not Hispanic or Latino</span></span>
<span><span class="co">#&gt; 2                     White alone, not Hispanic or Latino</span></span>
<span><span class="co">#&gt; 3                                      Hispanic or Latino</span></span>
<span><span class="co">#&gt; 4                      Other Race, not Hispanic or Latino</span></span>
<span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">lou_vax_survey_rep</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">RACE_ETHNICITY</span>,</span>
<span>          <span class="va">pums_rep_design</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">RACE_ETHNICITY</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">lou_vax_survey_rep</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">SEX</span>,</span>
<span>          <span class="va">pums_rep_design</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">SEX</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">lou_vax_survey_rep</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">EDUC_ATTAINMENT</span>,</span>
<span>          <span class="va">pums_rep_design</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">EDUC_ATTAINMENT</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimates from the control survey (ACS)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span></span>
<span>  design <span class="op">=</span> <span class="va">pums_rep_design</span>,</span>
<span>  x <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                          mean</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 0.19950</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                      0.04525</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                      0.04631</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     0.70894</span></span>
<span><span class="co">#&gt; SEXMale                                                               0.47543</span></span>
<span><span class="co">#&gt; SEXFemale                                                             0.52457</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  0.38736</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  0.61264</span></span>
<span><span class="co">#&gt;                                                                           SE</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 0.0010</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                      0.0002</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                      0.0008</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     0.0007</span></span>
<span><span class="co">#&gt; SEXMale                                                               0.0007</span></span>
<span><span class="co">#&gt; SEXFemale                                                             0.0007</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  0.0033</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  0.0033</span></span>
<span></span>
<span><span class="co"># Estimates from the primary survey (Louisville vaccination survey)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span></span>
<span>  design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  x <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                           mean</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 0.169323</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                      0.033865</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                      0.057769</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     0.739044</span></span>
<span><span class="co">#&gt; SEXFemale                                                             0.535857</span></span>
<span><span class="co">#&gt; SEXMale                                                               0.464143</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  0.458167</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  0.541833</span></span>
<span><span class="co">#&gt;                                                                           SE</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 0.0168</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                      0.0081</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                      0.0104</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     0.0196</span></span>
<span><span class="co">#&gt; SEXFemale                                                             0.0223</span></span>
<span><span class="co">#&gt; SEXMale                                                               0.0223</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  0.0223</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  0.0223</span></span></code></pre></div>
<div class="section level4">
<h4 id="raking-to-estimated-control-totals">Raking to estimated control totals<a class="anchor" aria-label="anchor" href="#raking-to-estimated-control-totals"></a>
</h4>
<p>We’ll start by raking to estimates from the ACS for race/ethnicity,
sex, and educational attainment, first using the
<code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code> method and then using the
<code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code> method. For the
<code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code> method, we need to obtain a vector of
point estimates for the control totals, and an accompanying
variance-covariance matrix for the estimates.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">acs_control_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>  design <span class="op">=</span> <span class="va">pums_rep_design</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">control_totals_for_raking</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">'estimates'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">acs_control_totals</span><span class="op">)</span>,</span>
<span>  <span class="st">'variance-covariance'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">acs_control_totals</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect point estimates</span></span>
<span><span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">estimates</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino </span></span>
<span><span class="co">#&gt;                                                                119041 </span></span>
<span><span class="co">#&gt;                                      RACE_ETHNICITYHispanic or Latino </span></span>
<span><span class="co">#&gt;                                                                 27001 </span></span>
<span><span class="co">#&gt;                      RACE_ETHNICITYOther Race, not Hispanic or Latino </span></span>
<span><span class="co">#&gt;                                                                 27633 </span></span>
<span><span class="co">#&gt;                     RACE_ETHNICITYWhite alone, not Hispanic or Latino </span></span>
<span><span class="co">#&gt;                                                                423027 </span></span>
<span><span class="co">#&gt;                                                               SEXMale </span></span>
<span><span class="co">#&gt;                                                                283688 </span></span>
<span><span class="co">#&gt;                                                             SEXFemale </span></span>
<span><span class="co">#&gt;                                                                313014 </span></span>
<span><span class="co">#&gt;                                  EDUC_ATTAINMENTHigh school or beyond </span></span>
<span><span class="co">#&gt;                                                                231136 </span></span>
<span><span class="co">#&gt;                                  EDUC_ATTAINMENTLess than high school </span></span>
<span><span class="co">#&gt;                                                                365566</span></span>
<span></span>
<span><span class="co"># Inspect a few rows of the control totals' variance-covariance matrix</span></span>
<span><span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">`variance-covariance`</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                           [,1]      [,2]        [,3]       [,4]</span></span>
<span><span class="co">#&gt; SEXMale                              355572.45 -29522.95   129208.95   196840.6</span></span>
<span><span class="co">#&gt; SEXFemale                            -29522.95 379494.65    81455.95   268515.8</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond 129208.95  81455.95  4019242.10 -3808577.2</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school 196840.55 268515.75 -3808577.20  4273933.5</span></span></code></pre></div>
<p>Crucially, we note that the vector of control totals has the same
names as the estimates produced by using <code><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal()</a></code> with
the primary survey design object whose weights we plan to adjust.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>         design <span class="op">=</span> <span class="va">nr_adjusted_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                        total</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 101035</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       20207</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       34471</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     440989</span></span>
<span><span class="co">#&gt; SEXFemale                                                             319747</span></span>
<span><span class="co">#&gt; SEXMale                                                               276955</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  273389</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  323313</span></span>
<span><span class="co">#&gt;                                                                            SE</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 10003.0</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       4824.4</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       6222.7</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     11713.1</span></span>
<span><span class="co">#&gt; SEXFemale                                                             13301.6</span></span>
<span><span class="co">#&gt; SEXMale                                                               13301.6</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  13289.2</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  13289.2</span></span></code></pre></div>
<p>To calibrate the design to the estimates, we supply the estimates and
the variance-covariance matrix to <code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code>,
and we supply the <code>cal_formula</code> argument with the same
formula we would use for <code><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal()</a></code>. To use a raking
adjustment, we specify <code>calfun = survey::cal.raking</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raked_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate</a></span><span class="op">(</span></span>
<span>  rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  estimate <span class="op">=</span> <span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">estimates</span>,</span>
<span>  vcov_estimate <span class="op">=</span> <span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">`variance-covariance`</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.raking</a></span>, <span class="co"># Required for raking</span></span>
<span>  epsilon <span class="op">=</span> <span class="fl">1e-9</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Selection of replicate columns whose control totals will be perturbed will be done at random.</span></span>
<span><span class="co">#&gt; For tips on reproducible selection, see `help('calibrate_to_estimate')`</span></span></code></pre></div>
<p>Now we can compare the estimated totals for the calibration variables
to the actual control totals. As we might intuitively expect, the
estimated totals from the survey now match the control totals, and the
standard errors for the estimated totals match the standard errors of
the control totals.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimated totals after calibration</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>         design <span class="op">=</span> <span class="va">raked_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                        total</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 119041</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       27001</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       27633</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     423027</span></span>
<span><span class="co">#&gt; SEXFemale                                                             313014</span></span>
<span><span class="co">#&gt; SEXMale                                                               283688</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  231136</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  365566</span></span>
<span><span class="co">#&gt;                                                                            SE</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino  633.63</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       107.98</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       472.41</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                      594.14</span></span>
<span><span class="co">#&gt; SEXFemale                                                              616.03</span></span>
<span><span class="co">#&gt; SEXMale                                                                596.30</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  2004.80</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  2067.35</span></span>
<span></span>
<span><span class="co"># Matches the control totals!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="st">'total'</span> <span class="op">=</span> <span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">estimates</span>,</span>
<span>  <span class="st">'SE'</span> <span class="op">=</span> <span class="va">control_totals_for_raking</span><span class="op">$</span><span class="va">`variance-covariance`</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                        total</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino 119041</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       27001</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       27633</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                     423027</span></span>
<span><span class="co">#&gt; SEXMale                                                               283688</span></span>
<span><span class="co">#&gt; SEXFemale                                                             313014</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  231136</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  365566</span></span>
<span><span class="co">#&gt;                                                                              SE</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYBlack or African American alone, not Hispanic or Latino  633.6287</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYHispanic or Latino                                       107.9829</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYOther Race, not Hispanic or Latino                       472.4107</span></span>
<span><span class="co">#&gt; RACE_ETHNICITYWhite alone, not Hispanic or Latino                      594.1448</span></span>
<span><span class="co">#&gt; SEXMale                                                                596.2990</span></span>
<span><span class="co">#&gt; SEXFemale                                                              616.0314</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTHigh school or beyond                                  2004.8048</span></span>
<span><span class="co">#&gt; EDUC_ATTAINMENTLess than high school                                  2067.3494</span></span></code></pre></div>
<p>We can now see what effect the raking adjustment has had on our
primary estimate of interest, which is the overall Covid-19 vaccination
rate. The raking adjustment has reduced our estimate of the vaccination
rate by about one percentage point and results in a similar standard
error estimate.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimates_by_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/svyby_repwts.html">svyby_repwts</a></span><span class="op">(</span></span>
<span>  rep_designs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"NR-adjusted"</span> <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>    <span class="st">"Raked"</span> <span class="op">=</span> <span class="va">raked_design</span></span>
<span>  <span class="op">)</span>,</span>
<span>  FUN <span class="op">=</span> <span class="va">svytotal</span>,</span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">estimates_by_design</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="74%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="right">NR-adjusted</th>
<th align="right">Raked</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">RACE_ETHNICITYBlack or African American alone, not
Hispanic or Latino</td>
<td align="right">101035.199</td>
<td align="right">119041.0000</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYHispanic or Latino</td>
<td align="right">20207.040</td>
<td align="right">27001.0000</td>
</tr>
<tr class="odd">
<td align="left">RACE_ETHNICITYOther Race, not Hispanic or Latino</td>
<td align="right">34470.833</td>
<td align="right">27633.0000</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYWhite alone, not Hispanic or Latino</td>
<td align="right">440988.928</td>
<td align="right">423027.0000</td>
</tr>
<tr class="odd">
<td align="left">SEXFemale</td>
<td align="right">319746.689</td>
<td align="right">313014.0000</td>
</tr>
<tr class="even">
<td align="left">SEXMale</td>
<td align="right">276955.311</td>
<td align="right">283688.0000</td>
</tr>
<tr class="odd">
<td align="left">EDUC_ATTAINMENTHigh school or beyond</td>
<td align="right">273389.363</td>
<td align="right">231136.0000</td>
</tr>
<tr class="even">
<td align="left">EDUC_ATTAINMENTLess than high school</td>
<td align="right">323312.637</td>
<td align="right">365566.0000</td>
</tr>
<tr class="odd">
<td align="left">se1</td>
<td align="right">10002.951</td>
<td align="right">633.5569</td>
</tr>
<tr class="even">
<td align="left">se2</td>
<td align="right">4824.430</td>
<td align="right">107.8772</td>
</tr>
<tr class="odd">
<td align="left">se3</td>
<td align="right">6222.719</td>
<td align="right">472.1548</td>
</tr>
<tr class="even">
<td align="left">se4</td>
<td align="right">11713.138</td>
<td align="right">594.1299</td>
</tr>
<tr class="odd">
<td align="left">se5</td>
<td align="right">13301.627</td>
<td align="right">615.0332</td>
</tr>
<tr class="even">
<td align="left">se6</td>
<td align="right">13301.627</td>
<td align="right">596.2981</td>
</tr>
<tr class="odd">
<td align="left">se7</td>
<td align="right">13289.206</td>
<td align="right">2004.2872</td>
</tr>
<tr class="even">
<td align="left">se8</td>
<td align="right">13289.206</td>
<td align="right">2065.8156</td>
</tr>
</tbody>
</table>
<p>Instead of doing the raking using a vector of control totals and
their variance-covariance matrix, we could have instead done the raking
by simply supplying the two replicate design objects to the function
<code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code>. This uses the Opsomer-Erciulescu
method of adjusting replicate weights, in contrast to
<code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code>, which uses Fuller’s method of
adjusting replicate weights.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raked_design_opsomer_erciulescu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_sample.html">calibrate_to_sample</a></span><span class="op">(</span></span>
<span>  primary_rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  control_rep_design <span class="op">=</span> <span class="va">pums_rep_design</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.raking</a></span>,</span>
<span>  epsilon <span class="op">=</span> <span class="fl">1e-9</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Matching between primary and control replicates will be done at random.</span></span>
<span><span class="co">#&gt; For tips on reproducible matching, see `help('calibrate_to_sample')`</span></span></code></pre></div>
<p>We can see that the two methods yield identical point estimates from
the full-sample weights, and the standard errors match nearly exactly
for the calibration variables (race/ethnicity, sex, and educational
attainment). However, there are small but slightly more noticeable
differences in the standard errors for other variables, such as
<code>VAX_STATUS</code>, resulting from the fact that the two methods
have different methods of adjusting the replicate weights. <span class="citation">Opsomer and Erciulescu (2021)</span> explain the
differences between the two methods and discuss why the the
Opsomer-Erciulescu method used in <code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code> may
have better statistical properties than the Fuller method used in
<code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimates_by_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/svyby_repwts.html">svyby_repwts</a></span><span class="op">(</span></span>
<span>  rep_designs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"calibrate_to_estimate()"</span> <span class="op">=</span> <span class="va">raked_design</span>,</span>
<span>    <span class="st">"calibrate_to_sample()"</span> <span class="op">=</span> <span class="va">raked_design_opsomer_erciulescu</span></span>
<span>  <span class="op">)</span>,</span>
<span>  FUN <span class="op">=</span> <span class="va">svytotal</span>,</span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="va">VAX_STATUS</span> <span class="op">+</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">estimates_by_design</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="60%">
<col width="20%">
<col width="18%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="right">calibrate_to_estimate()</th>
<th align="right">calibrate_to_sample()</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">VAX_STATUSUnvaccinated</td>
<td align="right">282904.4084</td>
<td align="right">282904.4084</td>
</tr>
<tr class="even">
<td align="left">VAX_STATUSVaccinated</td>
<td align="right">313797.5916</td>
<td align="right">313797.5916</td>
</tr>
<tr class="odd">
<td align="left">RACE_ETHNICITYBlack or African American alone, not
Hispanic or Latino</td>
<td align="right">119041.0000</td>
<td align="right">119041.0000</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYHispanic or Latino</td>
<td align="right">27001.0000</td>
<td align="right">27001.0000</td>
</tr>
<tr class="odd">
<td align="left">RACE_ETHNICITYOther Race, not Hispanic or Latino</td>
<td align="right">27633.0000</td>
<td align="right">27633.0000</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYWhite alone, not Hispanic or Latino</td>
<td align="right">423027.0000</td>
<td align="right">423027.0000</td>
</tr>
<tr class="odd">
<td align="left">SEXFemale</td>
<td align="right">313014.0000</td>
<td align="right">313014.0000</td>
</tr>
<tr class="even">
<td align="left">SEXMale</td>
<td align="right">283688.0000</td>
<td align="right">283688.0000</td>
</tr>
<tr class="odd">
<td align="left">EDUC_ATTAINMENTHigh school or beyond</td>
<td align="right">231136.0000</td>
<td align="right">231136.0000</td>
</tr>
<tr class="even">
<td align="left">EDUC_ATTAINMENTLess than high school</td>
<td align="right">365566.0000</td>
<td align="right">365566.0000</td>
</tr>
<tr class="odd">
<td align="left">se1</td>
<td align="right">13429.1361</td>
<td align="right">13404.4463</td>
</tr>
<tr class="even">
<td align="left">se2</td>
<td align="right">13395.3024</td>
<td align="right">13450.1643</td>
</tr>
<tr class="odd">
<td align="left">se3</td>
<td align="right">633.5569</td>
<td align="right">633.5867</td>
</tr>
<tr class="even">
<td align="left">se4</td>
<td align="right">107.8772</td>
<td align="right">107.9815</td>
</tr>
<tr class="odd">
<td align="left">se5</td>
<td align="right">472.1548</td>
<td align="right">471.9864</td>
</tr>
<tr class="even">
<td align="left">se6</td>
<td align="right">594.1299</td>
<td align="right">594.0839</td>
</tr>
<tr class="odd">
<td align="left">se7</td>
<td align="right">615.0332</td>
<td align="right">616.0278</td>
</tr>
<tr class="even">
<td align="left">se8</td>
<td align="right">596.2981</td>
<td align="right">596.2711</td>
</tr>
<tr class="odd">
<td align="left">se9</td>
<td align="right">2004.2872</td>
<td align="right">2003.8989</td>
</tr>
<tr class="even">
<td align="left">se10</td>
<td align="right">2065.8156</td>
<td align="right">2066.5749</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="post-stratification">Post-stratification<a class="anchor" aria-label="anchor" href="#post-stratification"></a>
</h4>
<p>The primary difference between post-stratification and raking is that
post-stratification essentially involves only a single calibration
variable, with population benchmarks provided for each value of that
variable. In the Louisville vaccination survey, that variable is called
<code>POSTSTRATUM</code> and is based on combinations of race/ethnicity,
sex, and educational attainment.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create matching post-stratification variable in both datasets</span></span>
<span>  <span class="va">nr_adjusted_design</span> <span class="op">&lt;-</span> <span class="va">nr_adjusted_design</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span>POSTSTRATUM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">RACE_ETHNICITY</span>, <span class="va">SEX</span>, <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>                                        sep <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pums_rep_design</span> <span class="op">&lt;-</span> <span class="va">pums_rep_design</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span>POSTSTRATUM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">RACE_ETHNICITY</span>, <span class="va">SEX</span>, <span class="va">EDUC_ATTAINMENT</span>,</span>
<span>                                        sep <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">pums_rep_design</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">POSTSTRATUM</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span></span>
<span>    <span class="va">nr_adjusted_design</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">POSTSTRATUM</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate control totals</span></span>
<span>  <span class="va">acs_control_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="op">~</span> <span class="va">POSTSTRATUM</span>,</span>
<span>    design <span class="op">=</span> <span class="va">pums_rep_design</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">poststratification_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">'estimate'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">acs_control_totals</span><span class="op">)</span>,</span>
<span>    <span class="st">'variance-covariance'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">acs_control_totals</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the control totals</span></span>
<span>  <span class="va">poststratification_totals</span><span class="op">$</span><span class="va">estimate</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="st">'estimate'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="92%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="right">estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">POSTSTRATUMBlack or African American alone, not
Hispanic or Latino|Female|High school or beyond</td>
<td align="right">12168</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMHispanic or Latino|Female|High school or
beyond</td>
<td align="right">3998</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMOther Race, not Hispanic or
Latino|Female|High school or beyond</td>
<td align="right">6190</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMWhite alone, not Hispanic or
Latino|Female|High school or beyond</td>
<td align="right">84041</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMBlack or African American alone, not
Hispanic or Latino|Male|High school or beyond</td>
<td align="right">17648</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMHispanic or Latino|Male|High school or
beyond</td>
<td align="right">4132</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMOther Race, not Hispanic or Latino|Male|High
school or beyond</td>
<td align="right">6687</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMWhite alone, not Hispanic or
Latino|Male|High school or beyond</td>
<td align="right">96272</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMBlack or African American alone, not
Hispanic or Latino|Female|Less than high school</td>
<td align="right">41944</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMHispanic or Latino|Female|Less than high
school</td>
<td align="right">10321</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMOther Race, not Hispanic or
Latino|Female|Less than high school</td>
<td align="right">6753</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMWhite alone, not Hispanic or
Latino|Female|Less than high school</td>
<td align="right">118273</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMBlack or African American alone, not
Hispanic or Latino|Male|Less than high school</td>
<td align="right">47281</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMHispanic or Latino|Male|Less than high
school</td>
<td align="right">8550</td>
</tr>
<tr class="odd">
<td align="left">POSTSTRATUMOther Race, not Hispanic or Latino|Male|Less
than high school</td>
<td align="right">8003</td>
</tr>
<tr class="even">
<td align="left">POSTSTRATUMWhite alone, not Hispanic or
Latino|Male|Less than high school</td>
<td align="right">124441</td>
</tr>
</tbody>
</table>
<p>To post-stratify the design, we can either supply the estimates and
their variance-covariance matrix to
<code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code>, or we can supply the two replicate
design objects to <code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code>. With either
method, we need to supply the <code>cal_formula</code> argument with the
same formula we would use for <code><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal()</a></code>. To use a
post-stratification adjustment (rather than raking), we specify
<code>calfun = survey::cal.linear</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Post-stratify the design using the estimates</span></span>
<span><span class="va">poststrat_design_fuller</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate</a></span><span class="op">(</span></span>
<span>  rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  estimate <span class="op">=</span> <span class="va">poststratification_totals</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  vcov_estimate <span class="op">=</span> <span class="va">poststratification_totals</span><span class="op">$</span><span class="va">`variance-covariance`</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">POSTSTRATUM</span>, <span class="co"># Specify the post-stratification variable</span></span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.linear</a></span> <span class="co"># This option is required for post-stratification</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Selection of replicate columns whose control totals will be perturbed will be done at random.</span></span>
<span><span class="co">#&gt; For tips on reproducible selection, see `help('calibrate_to_estimate')`</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Post-stratify the design using the two samples</span></span>
<span><span class="va">poststrat_design_opsomer_erciulescu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_sample.html">calibrate_to_sample</a></span><span class="op">(</span></span>
<span>  primary_rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  control_rep_design <span class="op">=</span> <span class="va">pums_rep_design</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">POSTSTRATUM</span>, <span class="co"># Specify the post-stratification variable</span></span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.linear</a></span> <span class="co"># This option is required for post-stratification</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Matching between primary and control replicates will be done at random.</span></span>
<span><span class="co">#&gt; For tips on reproducible matching, see `help('calibrate_to_sample')`</span></span></code></pre></div>
<p>As with the raking example, we can see that the full-sample
post-stratified estimates are exactly the same for the two methods. The
standard errors for post-stratification variables are essentially
identical, while the standard errors for other variables differ
slightly.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimates_by_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/svyby_repwts.html">svyby_repwts</a></span><span class="op">(</span></span>
<span>  rep_designs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"calibrate_to_estimate()"</span> <span class="op">=</span> <span class="va">poststrat_design_fuller</span>,</span>
<span>    <span class="st">"calibrate_to_sample()"</span> <span class="op">=</span> <span class="va">poststrat_design_opsomer_erciulescu</span></span>
<span>  <span class="op">)</span>,</span>
<span>  FUN <span class="op">=</span> <span class="va">svymean</span>,</span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="va">VAX_STATUS</span> <span class="op">+</span> <span class="va">RACE_ETHNICITY</span> <span class="op">+</span> <span class="va">SEX</span> <span class="op">+</span> <span class="va">EDUC_ATTAINMENT</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">estimates_by_design</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="60%">
<col width="20%">
<col width="18%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="right">calibrate_to_estimate()</th>
<th align="right">calibrate_to_sample()</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">VAX_STATUSUnvaccinated</td>
<td align="right">0.4779776</td>
<td align="right">0.4779776</td>
</tr>
<tr class="even">
<td align="left">VAX_STATUSVaccinated</td>
<td align="right">0.5220224</td>
<td align="right">0.5220224</td>
</tr>
<tr class="odd">
<td align="left">RACE_ETHNICITYBlack or African American alone, not
Hispanic or Latino</td>
<td align="right">0.1994982</td>
<td align="right">0.1994982</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYHispanic or Latino</td>
<td align="right">0.0452504</td>
<td align="right">0.0452504</td>
</tr>
<tr class="odd">
<td align="left">RACE_ETHNICITYOther Race, not Hispanic or Latino</td>
<td align="right">0.0463095</td>
<td align="right">0.0463095</td>
</tr>
<tr class="even">
<td align="left">RACE_ETHNICITYWhite alone, not Hispanic or Latino</td>
<td align="right">0.7089418</td>
<td align="right">0.7089418</td>
</tr>
<tr class="odd">
<td align="left">SEXFemale</td>
<td align="right">0.4754266</td>
<td align="right">0.4754266</td>
</tr>
<tr class="even">
<td align="left">SEXMale</td>
<td align="right">0.5245734</td>
<td align="right">0.5245734</td>
</tr>
<tr class="odd">
<td align="left">EDUC_ATTAINMENTHigh school or beyond</td>
<td align="right">0.3873558</td>
<td align="right">0.3873558</td>
</tr>
<tr class="even">
<td align="left">EDUC_ATTAINMENTLess than high school</td>
<td align="right">0.6126442</td>
<td align="right">0.6126442</td>
</tr>
<tr class="odd">
<td align="left">se1</td>
<td align="right">0.0234808</td>
<td align="right">0.0234727</td>
</tr>
<tr class="even">
<td align="left">se2</td>
<td align="right">0.0234808</td>
<td align="right">0.0234727</td>
</tr>
<tr class="odd">
<td align="left">se3</td>
<td align="right">0.0009757</td>
<td align="right">0.0009765</td>
</tr>
<tr class="even">
<td align="left">se4</td>
<td align="right">0.0001856</td>
<td align="right">0.0001856</td>
</tr>
<tr class="odd">
<td align="left">se5</td>
<td align="right">0.0007810</td>
<td align="right">0.0007802</td>
</tr>
<tr class="even">
<td align="left">se6</td>
<td align="right">0.0007033</td>
<td align="right">0.0007036</td>
</tr>
<tr class="odd">
<td align="left">se7</td>
<td align="right">0.0007463</td>
<td align="right">0.0007464</td>
</tr>
<tr class="even">
<td align="left">se8</td>
<td align="right">0.0007463</td>
<td align="right">0.0007464</td>
</tr>
<tr class="odd">
<td align="left">se9</td>
<td align="right">0.0033336</td>
<td align="right">0.0033324</td>
</tr>
<tr class="even">
<td align="left">se10</td>
<td align="right">0.0033336</td>
<td align="right">0.0033324</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="reproducibility">Reproducibility<a class="anchor" aria-label="anchor" href="#reproducibility"></a>
</h3>
<p>The calibration methods for <code><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate()</a></code> and
<code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code> involve one element of randomization:
determining which columns of replicate weights are assigned to a given
perturbation of the control totals. In the
<code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code> method of <span class="citation">Fuller (1998)</span>, if the control totals are a
vector of dimension <span class="math inline">\(p\)</span>, then <span class="math inline">\(p\)</span> columns of replicate weights will be
calibrated to <span class="math inline">\(p\)</span> different vectors
of perturbed control totals, formed using the <span class="math inline">\(p\)</span> scaled eigenvectors from a spectral
decomposition of the control totals’ variance-covariance matrix (sorted
in order by the largest to smallest eigenvalues). To control which
columns of replicate weights will be calibrated to each set of perturbed
control totals, we can use the function argument
<code>col_selection</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Randomly select which columns will be assigned to each set of perturbed control totals</span></span>
<span><span class="va">dimension_of_control_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">poststratification_totals</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">columns_to_perturb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">nr_adjusted_design</span><span class="op">$</span><span class="va">repweights</span><span class="op">)</span>,</span>
<span>                             size <span class="op">=</span> <span class="va">dimension_of_control_totals</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">columns_to_perturb</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 288 347 794 171 590 840 241 637 175 680 913 934 829 416 335  20</span></span>
<span></span>
<span><span class="co"># Perform the calibration</span></span>
<span><span class="va">poststratified_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_estimate.html">calibrate_to_estimate</a></span><span class="op">(</span></span>
<span>  rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  estimate <span class="op">=</span> <span class="va">poststratification_totals</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>  vcov_estimate <span class="op">=</span> <span class="va">poststratification_totals</span><span class="op">$</span><span class="va">`variance-covariance`</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">POSTSTRATUM</span>,</span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.linear</a></span>,</span>
<span>  col_selection <span class="op">=</span> <span class="va">columns_to_perturb</span> <span class="co"># Specified for reproducibility</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The calibrated survey design object contains an element
<code>perturbed_control_cols</code> which indicates which columns were
calibrated to the perturbed control totals; this can be useful to save
and use as an input to <code>col_selection</code> to ensure
reproducibility.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poststratified_design</span><span class="op">$</span><span class="va">perturbed_control_cols</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>For <code><a href="../reference/calibrate_to_sample.html">calibrate_to_sample()</a></code>, matching is done between
columns of replicate weights in the primary survey and columns of
replicate weights in the control survey. The matching is done at random
unless the user specifies otherwise using the argument
<code>control_col_matches</code>. In the Louisville Vaccination Survey,
the primary survey has 1,000 replicates while the control survey has 80
columns. So we can match these 80 columns to the 1,000 replicates by
specifying 1,000 values consisting of <code>NA</code> or integers
between 1 and 80.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Randomly match the primary replicates to control replicates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span></span>
<span></span>
<span><span class="va">column_matching</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">nr_adjusted_design</span><span class="op">$</span><span class="va">repweights</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">column_matching</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, size <span class="op">=</span> <span class="fl">80</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">80</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">column_matching</span><span class="op">)</span></span>
<span><span class="co">#&gt;  int [1:1000] NA NA NA 34 NA NA NA 68 NA NA ...</span></span>
<span></span>
<span><span class="co"># Perform the calibration</span></span>
<span><span class="va">poststratified_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_to_sample.html">calibrate_to_sample</a></span><span class="op">(</span></span>
<span>  primary_rep_design <span class="op">=</span> <span class="va">nr_adjusted_design</span>,</span>
<span>  control_rep_design <span class="op">=</span> <span class="va">pums_rep_design</span>,</span>
<span>  cal_formula <span class="op">=</span> <span class="op">~</span> <span class="va">POSTSTRATUM</span>,</span>
<span>  calfun <span class="op">=</span> <span class="fu">survey</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survey/man/make.calfun.html" class="external-link">cal.linear</a></span>,</span>
<span>  control_col_matches <span class="op">=</span> <span class="va">column_matching</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The calibrated survey design object contains an element
<code>control_column_matches</code> which control survey replicate each
primary survey replicate column was matched to.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">poststratified_design</span><span class="op">$</span><span class="va">control_column_matches</span><span class="op">)</span></span>
<span><span class="co">#&gt;  int [1:1000] NA NA NA 34 NA NA NA 68 NA NA ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-10.2307/24306529" class="csl-entry">
Fuller, Wayne A. 1998. <span>“Replication <span>Variance
Estimation</span> for <span>Two-Phase Samples</span>.”</span>
<em>Statistica Sinica</em> 8 (4): 1153–64.
</div>
<div id="ref-opsomerReplicationVarianceEstimation2021" class="csl-entry">
Opsomer, J. D., and A. L. Erciulescu. 2021. <span>“Replication Variance
Estimation After Sample-Based Calibration.”</span> <em>Survey
Methodology, Statistics Canada</em> Vol. 47 (No. 2).
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Schneider.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
