<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="svrep">
<title>Bootstrap Methods for Surveys • svrep</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bootstrap Methods for Surveys">
<meta property="og:description" content="svrep">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">svrep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/bootstrap-replicates.html">Bootstrap Methods for Surveys</a>
    <a class="dropdown-item" href="../articles/nonresponse-adjustments.html">Nonresponse Adjustments</a>
    <a class="dropdown-item" href="../articles/sample-based-calibration.html">Calibrating to Estimated Control Totals</a>
    <a class="dropdown-item" href="../articles/two-phase-sampling.html">Replication Methods for Two-phase Sampling</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bschneidr/svrep/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Bootstrap Methods for Surveys</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bschneidr/svrep/blob/HEAD/vignettes/bootstrap-replicates.Rmd" class="external-link"><code>vignettes/bootstrap-replicates.Rmd</code></a></small>
      <div class="d-none name"><code>bootstrap-replicates.Rmd</code></div>
    </div>

    
    
<p>This vignette provide guidance on when the bootstrap can be used for
complex survey data and how to choose a bootstrap method and number of
bootstrap replicates for a survey. It further demonstrates how to use
functions from the “svrep” package to implement bootstrap methods and
help decide the number of bootstrap replicates needed for your data.</p>
<p>The functions covered in this vignette include:</p>
<p><strong>Functions for Creating Bootstrap Weights</strong>:</p>
<ul>
<li><p><code><a href="../reference/as_bootstrap_design.html">as_bootstrap_design()</a></code>, which converts a survey
design object to a replicate survey design object with bootstrap
replicate weights.</p></li>
<li><p><code><a href="../reference/make_rwyb_bootstrap_weights.html">make_rwyb_bootstrap_weights()</a></code>, which creates
bootstrap replicate weights for general survey designs using the method
of Rao-Wu-Yue-Beaumont. The survey designs may potentially include
stratification, multistage clustering, and sampling with or without
replacement with unequal probabilities.</p></li>
</ul>
<p><strong>Functions for Creating Generalized Survey Bootstrap
Weights</strong>:</p>
<ul>
<li><p><code><a href="../reference/as_gen_boot_design.html">as_gen_boot_design()</a></code>, which creates a replicate
survey design using the generalized survey bootstrap method as described
by <span class="citation">Beaumont and Patak (2012)</span>.</p></li>
<li><p><code><a href="../reference/make_gen_boot_factors.html">make_gen_boot_factors()</a></code>, which creates a matrix of
replicate weights using the generalized survey bootstrap method. This
function will usually be used in conjunction with the functions
<code><a href="../reference/get_design_quad_form.html">get_design_quad_form()</a></code> or
<code><a href="../reference/make_quad_form_matrix.html">make_quad_form_matrix()</a></code>, which return the quadratic form
matrix representation of common variance estimators.</p></li>
</ul>
<p><strong>Functions to Help Choose the Number of Bootstrap
Replicates</strong>:</p>
<ul>
<li><p><code><a href="../reference/estimate_boot_sim_cv.html">estimate_boot_sim_cv()</a></code>, which estimates the
simulation error of a bootstrap estimate.</p></li>
<li><p><code><a href="../reference/estimate_boot_reps_for_target_cv.html">estimate_boot_reps_for_target_cv()</a></code>, which estimates
the number of bootstrap replicates needed to reduce a bootstrap’s
simulation error to a target level.</p></li>
</ul>
<div class="section level2">
<h2 id="choosing-a-bootstrap-method">Choosing a Bootstrap Method<a class="anchor" aria-label="anchor" href="#choosing-a-bootstrap-method"></a>
</h2>
<p>Essentially every bootstrap method commonly used for surveys can be
used for simple random sampling with replacement and can easily be
applied to stratified sampling (simply repeat the method separately for
each stratum). However, things become more complicated for other types
of sampling and care is needed to use a bootstrap method appropriate to
the survey design. For many common designs used in practice, it is
possible (and easy!) to use one of the bootstrap methods described in
the section of this vignette titled “Basic Bootstrap Methods.”</p>
<p>If the design isn’t appropriate for one of those basic bootstrap
methods, then it may be possible to use the generalized survey bootstrap
described in a later section of this vignette. The generalized survey
bootstrap method can be used for especially complex designs, such as
systematic sampling or two-phase sampling designs.</p>
<p>The interested reader is encouraged to read <span class="citation">Mashreghi, Haziza, and Léger (2016)</span> for an
overview of bootstrap methods developed for survey samples.</p>
</div>
<div class="section level2">
<h2 id="basic-bootstrap-methods">Basic Bootstrap Methods<a class="anchor" aria-label="anchor" href="#basic-bootstrap-methods"></a>
</h2>
<p>For most sample designs used in practice, there are three basic
survey design features that must be considered when choosing a bootstrap
method:</p>
<ul>
<li><p>Whether there are multiple stages of sampling</p></li>
<li><p>Whether the design uses without-replacement sampling with large
sampling fractions</p></li>
<li><p>Whether the design uses unequal-probability sampling (commonly
referred to as “probability proportional to size (PPS)” sampling in
statistics jargon)</p></li>
</ul>
<p>The ‘svrep’ and ‘survey’ packages implement four basic bootstrap
methods, each of which can handle one or more of these survey design
features. Of the four methods, the Rao-Wu-Yue-Beaumont bootstrap method
<span class="citation">(Beaumont and Émond 2022)</span> is the only one
able to directly handle all three of these design features and is thus
the default method used in the function
<code><a href="../reference/as_bootstrap_design.html">as_bootstrap_design()</a></code>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Preston’s method can handle both multistage samples and
without-replacement sampling with large sample fractions, but it is not
strictly applicable to designs with unequal probability sampling. The
Rao-Wu method is a special case of the Rao-Wu-Yue-Beaumont method and
only applies to designs where the first stage of sampling is with
replacement or where the first-stage sample fraction is small enough to
be ignored. The Canty-Davison method is only applicable to single-stage
designs with simple random sampling (with or without replacement) within
strata.&lt;/p&gt;"><sup>1</sup></a> The following table summarizes these four
basic bootstrap methods and their appropriateness for each of the common
design features described earlier.</p>
<table class="table">
<caption>Designs Covered by Each Bootstrap Method</caption>
<colgroup>
<col width="25%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Handles Multistage Samples?</th>
<th>Appropriate for Without-Replacement Sampling with Large Sample
Fractions?</th>
<th>Unequal Probability Sampling (PPS)?</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Rao-Wu-Yue-Beaumont</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Rao-Wu</td>
<td>Only if first-stage sampling is without replacement or has a small
sampling fraction</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="odd">
<td>Preston</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="even">
<td>Canty-Davison</td>
<td>Only if first-stage sampling is without replacement or has a small
sampling fraction</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody>
</table>
<table style="width:100%;" class="table">
<caption>Data Required for Each Bootstrap Method</caption>
<colgroup>
<col width="16%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="16%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Strata IDs</th>
<th>Cluster IDs</th>
<th>Final Sampling Weights</th>
<th>Finite Population Corrections</th>
<th>Selection Probabilities by Stage</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Rao-Wu-Yue-Beaumont</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes, if sampling is without-replacement</td>
<td>If the design has unequal probability sampling (PPS)</td>
</tr>
<tr class="even">
<td>Rao-Wu</td>
<td>Yes (first stage only)</td>
<td>Yes (first stage only)</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="odd">
<td>Preston</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes, if sampling is without replacement</td>
<td>No</td>
</tr>
<tr class="even">
<td>Canty-Davison</td>
<td>Yes (first-stage only)</td>
<td>Yes (first stage only)</td>
<td>Yes</td>
<td>Yes (first stage only), if sampling is without replacement</td>
<td>No</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h3>
<p>To implement these basic bootstrap methods, we can create a survey
design object with the <code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code> function from the survey
package, and then convert this object to a bootstrap replicate design
using <code><a href="../reference/as_bootstrap_design.html">as_bootstrap_design()</a></code>. This method can be used for
multistage, stratified designs with one or more different kinds of
sampling, provided the “Rao-Wu-Yue-Beaumont” method is used.</p>
<p><strong>Example 1: Multistage Simple Random Sampling without
Replacement (SRSWOR)</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span> <span class="co"># For complex survey analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bschneidr.github.io/svrep/">svrep</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load an example dataset from a multistage sample, with two stages of SRSWOR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"mu284"</span>, package <span class="op">=</span> <span class="st">'survey'</span><span class="op">)</span></span>
<span>  <span class="va">multistage_srswor_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mu284</span>,</span>
<span>                                        ids <span class="op">=</span> <span class="op">~</span> <span class="va">id1</span> <span class="op">+</span> <span class="va">id2</span>,</span>
<span>                                        fpc <span class="op">=</span> <span class="op">~</span> <span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">bootstrap_rep_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_bootstrap_design.html">as_bootstrap_design</a></span><span class="op">(</span><span class="va">multistage_srswor_design</span>,</span>
<span>                                              type <span class="op">=</span> <span class="st">"Rao-Wu-Yue-Beaumont"</span>,</span>
<span>                                              replicates <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">y1</span>, design <span class="op">=</span> <span class="va">multistage_srswor_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;    total     SE</span></span>
<span><span class="co">#&gt; y1 15080 2274.3</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">y1</span>, design <span class="op">=</span> <span class="va">bootstrap_rep_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;    total     SE</span></span>
<span><span class="co">#&gt; y1 15080 2311.1</span></span></code></pre></div>
<p><strong>Example 2: Single-stage unequal probability sampling without
replacement</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example dataset of U.S. counties and states with 2004 Presidential vote counts</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"election"</span>, package <span class="op">=</span> <span class="st">'survey'</span><span class="op">)</span></span>
<span>  <span class="va">pps_wor_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">election_pps</span>,</span>
<span>                              pps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/HR.html" class="external-link">HR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                              fpc <span class="op">=</span> <span class="op">~</span> <span class="va">p</span>, <span class="co"># Inclusion probabilities</span></span>
<span>                              ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">bootstrap_rep_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_bootstrap_design.html">as_bootstrap_design</a></span><span class="op">(</span><span class="va">pps_wor_design</span>,</span>
<span>                                              type <span class="op">=</span> <span class="st">"Rao-Wu-Yue-Beaumont"</span>,</span>
<span>                                              replicates <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">Bush</span> <span class="op">+</span> <span class="va">Kerry</span>, design <span class="op">=</span> <span class="va">pps_wor_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;          total      SE</span></span>
<span><span class="co">#&gt; Bush  64518472 2472753</span></span>
<span><span class="co">#&gt; Kerry 51202102 2426842</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">Bush</span> <span class="op">+</span> <span class="va">Kerry</span>, design <span class="op">=</span> <span class="va">bootstrap_rep_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;          total      SE</span></span>
<span><span class="co">#&gt; Bush  64518472 2331148</span></span>
<span><span class="co">#&gt; Kerry 51202102 2337653</span></span></code></pre></div>
<p><strong>Example 3: Multistage Sampling with Different Sampling
Methods at Each Stage</strong></p>
<p>For designs that use different sampling methods at different stages,
we can use the argument <code>samp_method_by_stage</code> to ensure that
the correct method is used to form the bootstrap weights. In general, if
a multistage design uses unequal probability sampling for only some
stages, then when creating the initial design object, the stage-specific
sampling probabilities should be supplied to the <code>fpc</code>
argument of the <code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code> function, and the user should
specify <code>pps = "brewer"</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Declare a multistage design</span></span>
<span><span class="co"># where first-stage probabilities are PPSWOR sampling</span></span>
<span><span class="co"># and second-stage probabilities are based on SRSWOR</span></span>
<span><span class="va">multistage_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">library_multistage_sample</span>,</span>
<span>  ids <span class="op">=</span> <span class="op">~</span> <span class="va">PSU_ID</span> <span class="op">+</span> <span class="va">SSU_ID</span>,</span>
<span>  probs <span class="op">=</span> <span class="op">~</span> <span class="va">PSU_SAMPLING_PROB</span> <span class="op">+</span> <span class="va">SSU_SAMPLING_PROB</span>,</span>
<span>  pps <span class="op">=</span> <span class="st">"brewer"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to a bootstrap replicate design</span></span>
<span><span class="va">boot_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_bootstrap_design.html">as_bootstrap_design</a></span><span class="op">(</span></span>
<span>  design <span class="op">=</span> <span class="va">multistage_design</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"Rao-Wu-Yue-Beaumont"</span>,</span>
<span>  samp_method_by_stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PPSWOR"</span>, <span class="st">"SRSWOR"</span><span class="op">)</span>,</span>
<span>  replicates <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare variance estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTCIR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">multistage_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;             total        SE</span></span>
<span><span class="co">#&gt; TOTCIR 1634739229 250890030</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTCIR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">boot_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;             total        SE</span></span>
<span><span class="co">#&gt; TOTCIR 1634739229 259570779</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="generalized-survey-bootstrap">Generalized Survey Bootstrap<a class="anchor" aria-label="anchor" href="#generalized-survey-bootstrap"></a>
</h2>
<p>For sample designs with additional complex features beyond the three
highlighted above, the generalized survey bootstrap method can be used.
This is especially useful for systematic samples, two-phase samples, or
complex designs where one wishes to use a general-purpose estimator such
as the Horvitz-Thompson or Yates-Grundy estimator.</p>
<div class="section level3">
<h3 id="statistical-background">Statistical Background<a class="anchor" aria-label="anchor" href="#statistical-background"></a>
</h3>
<p>The generalized survey bootstrap is based on a remarkable observation
from <span class="citation">Fay (1984)</span>, summarized nicely by
<span class="citation">Dippo, Fay, and Morganstein (1984)</span>:</p>
<blockquote>
<p><em>…there is no variance estimator based on sums of squares and
cross-products that cannot be represented by a resampling plan.</em></p>
<p>-- <span class="citation">Dippo, Fay, and Morganstein
(1984)</span></p>
</blockquote>
<p>In other words, if a sample design has a textbook variance estimator
for totals that can be represented as a quadratic form (i.e., sums of
squares and cross-products), then we can make a replication estimator
out of it. Fay developed a general methodology for producing replication
estimators from a textbook estimator’s quadratic form, encompassing the
jackknife, bootstrap, and balanced repeated replication as special
cases. Within this framework, the “generalized survey bootstrap”
developed by <span class="citation">Bertail and Combris (1997)</span> is
one specific strategy for making bootstrap replication estimators out of
textbook variance estimators. See <span class="citation">Beaumont and
Patak (2012)</span> for a clear overview of the generalized survey
bootstrap.</p>
<p>The starting point for implementing the generalized survey bootstrap
method is to choose a textbook variance estimator appropriate to the
sampling design which can be represented as a quadratic form. Luckily,
there are many useful variance estimators which can be represented as
quadratic forms. We highlight a few prominent examples below:</p>
<ul>
<li>
<p>For stratified, multistage cluster samples:</p>
<ul>
<li>The usual multistage variance estimator used in the ‘survey’
package, based on adding variance contributions from each stage. The
estimator can be used for any number of sampling stages.</li>
</ul>
</li>
<li>
<p>Highly-general variance estimators which work for any
‘measurable’ survey design (i.e., designs where every pair of units in
the population has a nonzero probability of appearing in the sample).
This covers most designs used in practice, with the primary exceptions
being “one-PSU-per-stratum” designs and systematic sampling designs.</p>
<ul>
<li><p>The Horvitz-Thompson estimator</p></li>
<li><p>The Sen-Yates-Grundy estimator</p></li>
</ul>
</li>
<li>
<p>For systematic samples:</p>
<ul>
<li>The SD1 and SD2 successive-differences estimators, which are the
basis of the commonly-used “successive-differences replication” (SDR)
estimator (see <span class="citation">Ash (2014)</span> for an overview
of SDR).</li>
</ul>
</li>
<li>
<p>For two-phase samples:</p>
<ul>
<li>The double-expansion variance estimator described in Section 9.3 of
<span class="citation">Särndal, Swensson, and Wretman
(1992)</span>.</li>
</ul>
</li>
</ul>
<p>Once the textbook variance estimator has been selected and its
quadratic form identified, the generalized survey bootstrap method
consists of randomly generating each set of replicate weights from a
multivariate distribution whose expectation is the <span class="math inline">\(n\)</span>-vector <span class="math inline">\(\mathbf{1}_n\)</span> and whose
variance-covariance matrix is the matrix of the quadratic form used for
the textbook variance estimator. This ensures that, in expectation, the
bootstrap variance estimator for a total equals the textbook variance
estimator and thus inherits properties such as design-unbiasedness and
design-consistency.</p>
</div>
<div class="section level3">
<h3 id="details-and-notation-for-the-generalized-survey-bootstrap-method">Details and Notation for the Generalized Survey Bootstrap
Method<a class="anchor" aria-label="anchor" href="#details-and-notation-for-the-generalized-survey-bootstrap-method"></a>
</h3>
<p>In this section, we describe the generalized survey bootstrap in
greater detail, using the notation of <span class="citation">Beaumont
and Patak (2012)</span>.</p>
<div class="section level4">
<h4 id="quadratic-forms">Quadratic Forms<a class="anchor" aria-label="anchor" href="#quadratic-forms"></a>
</h4>
<p>Let <span class="math inline">\(v( \hat{T_y})\)</span> be the
textbook variance estimator for an estimated population total <span class="math inline">\(\hat{T}_y\)</span> of some variable <span class="math inline">\(y\)</span>. The base weight for case <span class="math inline">\(i\)</span> in our sample is <span class="math inline">\(w_i\)</span>, and we let <span class="math inline">\(\breve{y}_i\)</span> denote the weighted value
<span class="math inline">\(w_iy_i\)</span>.</p>
<p>Suppose we can represent our textbook variance estimator as a
quadratic form: <span class="math inline">\(v(\hat{T}_y) =
\breve{y}\Sigma\breve{y}^T\)</span>, for some <span class="math inline">\(n \times n\)</span> matrix <span class="math inline">\(\Sigma\)</span>. Our only constraint on <span class="math inline">\(\Sigma\)</span> is that, for our sample, it must
be symmetric and positive semi-definite (in other words, it should never
lead to a negative variance estimate, no matter what the value of <span class="math inline">\(\breve{y}\)</span> is).</p>
<p>For example, the popular Horvitz-Thompson estimator based on
first-order inclusion probabilities <span class="math inline">\(\pi_k\)</span> and second-order inclusion
probabilities <span class="math inline">\(\pi_{kl}\)</span> can be
represented as a positive semi-definite matrix with entries <span class="math inline">\((1-\pi_k)\)</span> along the main diagonal and
entries <span class="math inline">\((1 - \frac{\pi_k
\pi_l}{\pi_{kl}})\)</span> everywhere else. An illustration for a sample
with <span class="math inline">\(n=3\)</span> is shown below:</p>
<p><span class="math display">\[
\Sigma_{HT} = \begin{bmatrix}
(1-\pi_1) &amp; (1 - \frac{\pi_1 \pi_2}{\pi_{12}}) &amp; (1 -
\frac{\pi_1 \pi_3}{\pi_{13}}) \\
(1 - \frac{\pi_2 \pi_1}{\pi_{21}}) &amp; (1 - \pi_2) &amp; (1 -
\frac{\pi_2 \pi_3}{\pi_{23}}) \\
(1 - \frac{\pi_3 \pi_1}{\pi_{31}}) &amp; (1 - \frac{\pi_3
\pi_2}{\pi_{32}}) &amp; (1 - \pi_3)
\end{bmatrix}
\]</span></p>
<p>As another example, the successive-difference variance estimator for
a systematic sample can be represented as a positive semi-definite
matrix whose diagonal entries are all <span class="math inline">\(1\)</span>, whose superdiagonal and subdiagonal
entries are all <span class="math inline">\(-1/2\)</span>, and whose top
right and bottom left entries are <span class="math inline">\(-1/2\)</span> <span class="citation">(Ash
2014)</span>. An illustration for a sample with <span class="math inline">\(n=5\)</span> is shown below:</p>
<p><span class="math display">\[
\Sigma_{SD2} = \begin{bmatrix}
1 &amp; -1/2 &amp; 0 &amp; 0 &amp; -1/2\\
-1/2 &amp; 1 &amp; -1/2 &amp; 0 &amp; 0 \\
0 &amp; -1/2 &amp; 1 &amp; -1/2 &amp; 0 \\
0 &amp; 0 &amp; -1/2 &amp; 1&amp; -1/2 \\
-1/2 &amp; 0 &amp; 0 &amp; -1/2 &amp; 1
\end{bmatrix}
\]</span></p>
<p>To obtain a quadratic form matrix for a variance estimator, we can
use the function <code><a href="../reference/make_quad_form_matrix.html">make_quad_form_matrix()</a></code>, which takes as
inputs the name of a variance estimator and relevant survey design
information. For example, the following code produces the quadratic form
matrix of the “SD2” variance estimator we saw earlier.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/make_quad_form_matrix.html">make_quad_form_matrix</a></span><span class="op">(</span></span>
<span>    variance_estimator <span class="op">=</span> <span class="st">"SD2"</span>,</span>
<span>    cluster_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    strata_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    sort_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt; [1,]  1.0 -0.5  0.0  0.0 -0.5</span></span>
<span><span class="co">#&gt; [2,] -0.5  1.0 -0.5  0.0  0.0</span></span>
<span><span class="co">#&gt; [3,]  0.0 -0.5  1.0 -0.5  0.0</span></span>
<span><span class="co">#&gt; [4,]  0.0  0.0 -0.5  1.0 -0.5</span></span>
<span><span class="co">#&gt; [5,] -0.5  0.0  0.0 -0.5  1.0</span></span></code></pre></div>
<p>In the following example, we use this method to estimate the variance
for a stratified systematic sample of U.S. public libraries. First, we
create a quadratic form matrix to represent the SD2
successive-difference estimator. This can be done by using the
<code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code> function to describe the survey design and then
using <code><a href="../reference/get_design_quad_form.html">get_design_quad_form()</a></code> to obtain the quadratic form
for a specified variance estimator.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load an example dataset of a stratified systematic sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First, sort the rows in the order used in sampling</span></span>
<span><span class="va">library_stsys_sample</span> <span class="op">&lt;-</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">SAMPLING_SORT_ORDER</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a survey design object</span></span>
<span><span class="va">survey_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">library_stsys_sample</span>,</span>
<span>  ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  strata <span class="op">=</span> <span class="op">~</span> <span class="va">SAMPLING_STRATUM</span>,</span>
<span>  fpc <span class="op">=</span> <span class="op">~</span> <span class="va">STRATUM_POP_SIZE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Obtain the quadratic form for the target estimator</span></span>
<span><span class="va">sd2_quad_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_design_quad_form.html">get_design_quad_form</a></span><span class="op">(</span></span>
<span>  design <span class="op">=</span> <span class="va">survey_design</span>,</span>
<span>  variance_estimator <span class="op">=</span> <span class="st">"SD2"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; For `variance_estimator='SD2', assumes rows of data are sorted in the same order used in sampling.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">sd2_quad_form</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "matrix" "array"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sd2_quad_form</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 219 219</span></span></code></pre></div>
<p>Next, we estimate the sampling variance of the estimated total for
the <code>TOTCIR</code> variable using the quadratic form.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Obtain weighted values</span></span>
<span><span class="va">wtd_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">library_stsys_sample</span><span class="op">[[</span><span class="st">'LIBRARIA'</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span></span>
<span>                     <span class="va">library_stsys_sample</span><span class="op">[[</span><span class="st">'SAMPLING_PROB'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">wtd_y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Obtain point estimate for a population total</span></span>
<span><span class="va">point_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Obtain the variance estimate using the quadratic form</span></span>
<span><span class="va">variance_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">wtd_y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">sd2_quad_form</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">wtd_y</span></span>
<span><span class="va">std_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">variance_estimate</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Estimate: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">point_estimate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estimate: 65642"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Standard Error: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">std_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Standard Error: 13972"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="forming-adjustment-factors">Forming Adjustment Factors<a class="anchor" aria-label="anchor" href="#forming-adjustment-factors"></a>
</h4>
<p>Our goal is to form <span class="math inline">\(B\)</span> sets of
bootstrap weights, where the <span class="math inline">\(b\)</span>-th
set of bootstrap weights is a vector of length <span class="math inline">\(n\)</span> denoted <span class="math inline">\(\mathbf{a}^{(b)}\)</span>, whose <span class="math inline">\(k\)</span>-th value is denoted <span class="math inline">\(a_k^{(b)}\)</span>. This gives us <span class="math inline">\(B\)</span> replicate estimates of the population
total, <span class="math inline">\(\hat{T}_y^{*(b)}=\sum_{k \in s}
a_k^{(b)} \breve{y}_k\)</span>, for <span class="math inline">\(b=1,
\ldots B\)</span>, from which we can easily calculate an estimate of the
sampling variance.</p>
<p><span class="math display">\[
v_B\left(\hat{T}_y\right)=\frac{\sum_{b=1}^B\left(\hat{T}_y^{*(b)}-\hat{T}_y\right)^2}{B}
\]</span></p>
<p>We can write this bootstrap variance estimator as a quadratic
form:</p>
<p><span class="math display">\[
\begin{aligned}
v_B\left(\hat{T}_y\right) &amp;=\mathbf{\breve{y}}^{\prime}\Sigma_B
\mathbf{\breve{y}} \\
\textit{where}&amp; \\
\boldsymbol{\Sigma}_B &amp;=
\frac{\sum_{b=1}^B\left(\mathbf{a}^{(b)}-\mathbf{1}_n\right)\left(\mathbf{a}^{(b)}-\mathbf{1}_n\right)^{\prime}}{B}
\end{aligned}
\]</span></p>
<p>Note that if the vector of adjustment factors <span class="math inline">\(\mathbf{a}^{(b)}\)</span> has expectation <span class="math inline">\(\mathbf{1}_n\)</span> and variance-covariance
matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>, then we
have the bootstrap expectation <span class="math inline">\(E_{*}\left(
\boldsymbol{\Sigma}_B \right) = \boldsymbol{\Sigma}\)</span>. Since the
bootstrap process takes the sample values <span class="math inline">\(\breve{y}\)</span> as fixed, the bootstrap
expectation of the variance estimator is <span class="math inline">\(E_{*} \left( \mathbf{\breve{y}}^{\prime}\Sigma_B
\mathbf{\breve{y}}\right)= \mathbf{\breve{y}}^{\prime}\Sigma
\mathbf{\breve{y}}\)</span>. Thus, we can produce a bootstrap variance
estimator with the same expectation as the textbook variance estimator
simply by randomly generating <span class="math inline">\(\mathbf{a}^{(b)}\)</span> from a distribution with
the following two conditions:</p>
<p><u><strong>Condition 1</strong></u>: <span class="math inline">\(\quad
\mathbf{E}_*(\mathbf{a})=\mathbf{1}_n\)</span></p>
<p><u><strong>Condition 2</strong></u>: <span class="math inline">\(\quad
\mathbf{E}_*\left(\mathbf{a}-\mathbf{1}_n\right)\left(\mathbf{a}-\mathbf{1}_n\right)^{\prime}=\mathbf{\Sigma}\)</span></p>
<p>The simplest, general way to generate the adjustment factors is to
simulate from a multivariate normal distribution <span class="math inline">\(\mathbf{a} \sim MVN(\mathbf{1}_n,
\boldsymbol{\Sigma})\)</span>, which is the method used in this package.
However, this method can lead to negative adjustment factors and hence
negative bootstrap weights, which–while perfectly valid for variance
estimation–may be undesirable from a practical point of view. Thus, in
the following subsection, we describe one method for adjusting the
replicate factors so that they are nonnegative and <span class="math inline">\(E_{*} \left( \mathbf{\breve{y}}^{\prime}\Sigma_B
\mathbf{\breve{y}}\right) =\mathbf{\breve{y}}^{\prime}\Sigma
\mathbf{\breve{y}}\)</span>.</p>
</div>
<div class="section level4">
<h4 id="adjusting-generalized-survey-bootstrap-replicates-to-avoid-negative-weights">Adjusting Generalized Survey Bootstrap Replicates to Avoid Negative
Weights<a class="anchor" aria-label="anchor" href="#adjusting-generalized-survey-bootstrap-replicates-to-avoid-negative-weights"></a>
</h4>
<p>Let <span class="math inline">\(\mathbf{A} = \left[ \mathbf{a}^{(1)}
\cdots \mathbf{a}^{(b)} \cdots \mathbf{a}^{(B)} \right]\)</span> denote
the <span class="math inline">\((n \times B)\)</span> matrix of
bootstrap adjustment factors. To eliminate negative adjustment factors,
<span class="citation">Beaumont and Patak (2012)</span> propose forming
a rescaled matrix of nonnegative replicate factors <span class="math inline">\(\mathbf{A}^S\)</span> by rescaling each adjustment
factor <span class="math inline">\(a_k^{(b)}\)</span> as follows:</p>
<p><span class="math display">\[
\begin{aligned}
a_k^{S,(b)} &amp;= \frac{a_k^{(b)} + \tau - 1}{\tau} \\
\textit{where } \tau &amp;\geq 1 - a_k^{(b)} \geq 1 \\
&amp;\textit{for all }k \textit{ in } \left\{ 1,\ldots,n \right\} \\
&amp;\textit{and all }b \textit{ in } \left\{1, \ldots, B\right\} \\
\end{aligned}
\]</span></p>
<p>The value of <span class="math inline">\(\tau\)</span> can be set
based on the realized adjustment factor matrix <span class="math inline">\(\mathbf{A}\)</span> or by choosing <span class="math inline">\(\tau\)</span> prior to generating the adjustment
factor matrix <span class="math inline">\(\mathbf{A}\)</span> so that
<span class="math inline">\(\tau\)</span> is likely to be large enough
to prevent negative bootstrap weights.</p>
<p>If the adjustment factors are rescaled in this manner, it is
important to adjust the scale factor used in estimating the variance
with the bootstrap replicates, which becomes <span class="math inline">\(\frac{\tau^2}{B}\)</span> instead of <span class="math inline">\(\frac{1}{B}\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\textbf{Prior to rescaling: } v_B\left(\hat{T}_y\right) &amp;=
\frac{1}{B}\sum_{b=1}^B\left(\hat{T}_y^{*(b)}-\hat{T}_y\right)^2 \\
\textbf{After rescaling: } v_B\left(\hat{T}_y\right) &amp;=
\frac{\tau^2}{B}\sum_{b=1}^B\left(\hat{T}_y^{S*(b)}-\hat{T}_y\right)^2
\\
\end{aligned}
\]</span></p>
<p>When sharing a dataset that uses rescaled weights from a generalized
survey bootstrap, the documentation for the dataset should instruct the
user to use replication scale factor <span class="math inline">\(\frac{\tau^2}{B}\)</span> rather than <span class="math inline">\(\frac{1}{B}\)</span> when estimating sampling
variances.</p>
</div>
</div>
<div class="section level3">
<h3 id="implementation-1">Implementation<a class="anchor" aria-label="anchor" href="#implementation-1"></a>
</h3>
<p>There are two ways to implement the generalized survey bootstrap.</p>
<div class="section level4">
<h4 id="option-1-convert-an-existing-design-to-a-generalized-bootstrap-design">Option 1: Convert an existing design to a generalized bootstrap
design<a class="anchor" aria-label="anchor" href="#option-1-convert-an-existing-design-to-a-generalized-bootstrap-design"></a>
</h4>
<p>The simplest method is to convert an existing survey design object to
a generalized bootstrap design.</p>
<p>With this approach, we create a survey design object using the
<code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code> function. This allows us to represent
information about stratification and clustering (potentially at multiple
stages), as well as information about finite population corrections.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data from stratified systematic sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First, ensure data are sorted in same order as was used in sampling</span></span>
<span><span class="va">library_stsys_sample</span> <span class="op">&lt;-</span> <span class="va">library_stsys_sample</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">library_stsys_sample</span><span class="op">$</span><span class="va">SAMPLING_SORT_ORDER</span><span class="op">)</span>,</span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create a survey design object</span></span>
<span><span class="va">design_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">library_stsys_sample</span>,</span>
<span>  strata <span class="op">=</span> <span class="op">~</span> <span class="va">SAMPLING_STRATUM</span>,</span>
<span>  ids <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  fpc <span class="op">=</span> <span class="op">~</span> <span class="va">STRATUM_POP_SIZE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we convert the survey design object to a replicate design using
the function <code><a href="../reference/as_gen_boot_design.html">as_gen_boot_design()</a></code>. The function argument
<code>variance_estimator</code> allows us to specify the name of a
variance estimator to use as the basis for creating replicate
weights.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert to generalized bootstrap replicate design</span></span>
<span><span class="va">gen_boot_design_sd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_gen_boot_design.html">as_gen_boot_design</a></span><span class="op">(</span></span>
<span>  design <span class="op">=</span> <span class="va">design_obj</span>,</span>
<span>  variance_estimator <span class="op">=</span> <span class="st">"SD2"</span>,</span>
<span>  replicates <span class="op">=</span> <span class="fl">2000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; For `variance_estimator='SD2', assumes rows of data are sorted in the same order used in sampling.</span></span>
<span></span>
<span><span class="co"># Estimate sampling variances</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTSTAFF</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">gen_boot_design_sd2</span><span class="op">)</span></span>
<span><span class="co">#&gt;            mean     SE</span></span>
<span><span class="co">#&gt; TOTSTAFF 19.756 4.2644</span></span></code></pre></div>
<p>For a PPS design that uses the Horvitz-Thompson or Yates-Grundy
estimator, we can create a generalized bootstrap estimator with the same
expectation. In the example below, we create a PPS design with the
‘survey’ package and convert it to a generalied bootstrap design.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data of a PPS survey of counties and states</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'election'</span>, package <span class="op">=</span> <span class="st">'survey'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create survey design object</span></span>
<span>   <span class="va">pps_design_ht</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>     data <span class="op">=</span> <span class="va">election_pps</span>,</span>
<span>     id <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, fpc <span class="op">=</span> <span class="op">~</span><span class="va">p</span>,</span>
<span>     pps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/HR.html" class="external-link">ppsmat</a></span><span class="op">(</span><span class="va">election_jointprob</span><span class="op">)</span>,</span>
<span>     variance <span class="op">=</span> <span class="st">"HT"</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span>  </span>
<span><span class="co"># Convert to generalized bootstrap replicate design</span></span>
<span><span class="va">gen_boot_design_ht</span> <span class="op">&lt;-</span> <span class="va">pps_design_ht</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_gen_boot_design.html">as_gen_boot_design</a></span><span class="op">(</span>variance_estimator <span class="op">=</span> <span class="st">"Horvitz-Thompson"</span>,</span>
<span>                     replicates <span class="op">=</span> <span class="fl">5000</span>, tau <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare sampling variances from bootstrap vs. Horvitz-Thompson estimator</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">Bush</span> <span class="op">+</span> <span class="va">Kerry</span>, design <span class="op">=</span> <span class="va">pps_design_ht</span><span class="op">)</span></span>
<span><span class="co">#&gt;          total      SE</span></span>
<span><span class="co">#&gt; Bush  64518472 2604404</span></span>
<span><span class="co">#&gt; Kerry 51202102 2523712</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">Bush</span> <span class="op">+</span> <span class="va">Kerry</span>, design <span class="op">=</span> <span class="va">gen_boot_design_ht</span><span class="op">)</span></span>
<span><span class="co">#&gt;          total      SE</span></span>
<span><span class="co">#&gt; Bush  64518472 2627361</span></span>
<span><span class="co">#&gt; Kerry 51202102 2499754</span></span></code></pre></div>
<p>We can also use the generalized bootstrap for designs that use
multistage, stratified simple random sampling without replacement.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># For data manipulation</span></span>
<span></span>
<span><span class="co"># Create a multistage survey design</span></span>
<span>  <span class="va">multistage_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">library_multistage_sample</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Weight <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">SAMPLING_PROB</span><span class="op">)</span>,</span>
<span>    ids <span class="op">=</span> <span class="op">~</span> <span class="va">PSU_ID</span> <span class="op">+</span> <span class="va">SSU_ID</span>,</span>
<span>    fpc <span class="op">=</span> <span class="op">~</span> <span class="va">PSU_POP_SIZE</span> <span class="op">+</span> <span class="va">SSU_POP_SIZE</span>,</span>
<span>    weights <span class="op">=</span> <span class="op">~</span> <span class="va">Weight</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to a generalized bootstrap design</span></span>
<span>  <span class="va">multistage_boot_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_gen_boot_design.html">as_gen_boot_design</a></span><span class="op">(</span></span>
<span>    design <span class="op">=</span> <span class="va">multistage_design</span>,</span>
<span>    variance_estimator <span class="op">=</span> <span class="st">"Stratified Multistage SRS"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare variance estimates</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTCIR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">multistage_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;             total        SE</span></span>
<span><span class="co">#&gt; TOTCIR 1634739229 251589313</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svytotal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTCIR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, design <span class="op">=</span> <span class="va">multistage_boot_design</span><span class="op">)</span></span>
<span><span class="co">#&gt;             total        SE</span></span>
<span><span class="co">#&gt; TOTCIR 1634739229 236364980</span></span></code></pre></div>
<p>Unless specified otherwise, <code><a href="../reference/as_gen_boot_design.html">as_gen_boot_design()</a></code>
automatically selects a rescaling value <span class="math inline">\(\tau\)</span> to use for eliminating negative
adjustment factors. The <code>scale</code> attribute of the resulting
replicate survey design object is thus set to equal <span class="math inline">\(\tau^2/B\)</span>. The specific value of <span class="math inline">\(\tau\)</span> can be retrieved from the replicate
design object, as follows.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View overall scale factor</span></span>
<span><span class="va">overall_scale_factor</span> <span class="op">&lt;-</span> <span class="va">gen_boot_design_ht</span><span class="op">$</span><span class="va">scale</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">overall_scale_factor</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.00472392</span></span>
<span></span>
<span><span class="co"># Check that the scale factor was calculated correctly</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="va">gen_boot_design_ht</span><span class="op">$</span><span class="va">tau</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4.86</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">gen_boot_design_ht</span><span class="op">$</span><span class="va">repweights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span> <span class="op">(</span><span class="va">tau</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.00472392</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="option-2-create-the-quadratic-form-matrix-and-then-use-it-to-create-bootstrap-weights">Option 2: Create the quadratic form matrix and then use it to create
bootstrap weights<a class="anchor" aria-label="anchor" href="#option-2-create-the-quadratic-form-matrix-and-then-use-it-to-create-bootstrap-weights"></a>
</h4>
<p>The generalized survey bootstrap can be implemented with a two-step
process:</p>
<ul>
<li>
<strong>Step 1</strong>: Use <code><a href="../reference/make_quad_form_matrix.html">make_quad_form_matrix()</a></code> to
represent the variance estimator as a quadratic form’s matrix.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load an example dataset of a stratified systematic sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'library_stsys_sample'</span>, package <span class="op">=</span> <span class="st">'svrep'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Represent the SD2 successive-difference estimator as a quadratic form,</span></span>
<span><span class="co"># and obtain the matrix of that quadratic form</span></span>
<span><span class="va">sd2_quad_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_quad_form_matrix.html">make_quad_form_matrix</a></span><span class="op">(</span></span>
<span>  variance_estimator <span class="op">=</span> <span class="st">'SD2'</span>,</span>
<span>  cluster_ids <span class="op">=</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">FSCSKEY</span><span class="op">)</span>,</span>
<span>  strata_ids <span class="op">=</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">SAMPLING_STRATUM</span><span class="op">)</span>,</span>
<span>  strata_pop_sizes <span class="op">=</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">STRATUM_POP_SIZE</span><span class="op">)</span>,</span>
<span>  sort_order <span class="op">=</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="st">"SAMPLING_SORT_ORDER"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<strong>Step 2</strong>: Use <code><a href="../reference/make_gen_boot_factors.html">make_gen_boot_factors()</a></code> to
generate replicate factors based on the target quadratic form. The
function argument <code>tau</code> can be used to avoid negative
adjustment factors using the previously-described method.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_adj_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_gen_boot_factors.html">make_gen_boot_factors</a></span><span class="op">(</span></span>
<span>  Sigma <span class="op">=</span> <span class="va">sd2_quad_form</span>,</span>
<span>  num_replicates <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  tau <span class="op">=</span> <span class="st">"auto"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The actual value of <code>tau</code> used can be extracted from the
function’s output using the <code><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr()</a></code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_adj_factors</span>, <span class="st">'tau'</span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rep_adj_factors</span><span class="op">)</span></span></code></pre></div>
<p>For convenience, the values to use for the <code>scale</code> and
<code>rscales</code> arguments of <code><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign()</a></code> are
included as attributes of the adjustment factors created by
<code><a href="../reference/make_gen_boot_factors.html">make_gen_boot_factors()</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Retrieve value of 'scale'</span></span>
<span><span class="va">rep_adj_factors</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="st">'scale'</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 0.0445568</span></span>
<span></span>
<span><span class="co"># Compare to manually-calculated value</span></span>
<span>  <span class="op">(</span><span class="va">tau</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span></span>
<span><span class="co">#&gt; [1] 0.0445568</span></span>
<span></span>
<span><span class="co"># Retrieve value of 'rscales'</span></span>
<span><span class="va">rep_adj_factors</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="st">'rscales'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Only show first 5 values</span></span>
<span><span class="co">#&gt; [1] 1 1 1 1 1 1</span></span></code></pre></div>
<p>Using the adjustment factors thus created, we can create a replicate
survey design object by using the function <code><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign()</a></code>,
with arguments <code>type = "other"</code> and specifying the
<code>scale</code> argument to use the factor <span class="math inline">\(\tau^2/B\)</span>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen_boot_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">library_stsys_sample</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SAMPLING_WEIGHT <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">SAMPLING_PROB</span><span class="op">)</span>,</span>
<span>  repweights <span class="op">=</span> <span class="va">rep_adj_factors</span>,</span>
<span>  weights <span class="op">=</span> <span class="op">~</span> <span class="va">SAMPLING_WEIGHT</span>,</span>
<span>  combined.weights <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"other"</span>,</span>
<span>  scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_adj_factors</span>, <span class="st">'scale'</span><span class="op">)</span>,</span>
<span>  rscales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rep_adj_factors</span>, <span class="st">'rscales'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This allows us to estimate sampling variances, even for quite complex
sampling designs.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen_boot_design</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">TOTSTAFF</span>,</span>
<span>          na.rm <span class="op">=</span> <span class="cn">TRUE</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;             mean      SE DEff</span></span>
<span><span class="co">#&gt; TOTSTAFF 19.7565  4.2024 0.97</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="choosing-the-number-of-bootstrap-replicates">Choosing the Number of Bootstrap Replicates<a class="anchor" aria-label="anchor" href="#choosing-the-number-of-bootstrap-replicates"></a>
</h2>
<p>The bootstrap suffers from unavoidable “simulation error” (also
referred to as “Monte Carlo” error) caused by using a finite number of
replicates to simulate the ideal bootstrap estimate we would obtain if
we used an infinite number of replicates. In general, the simulation
error can be reduced by using a larger number of bootstrap
replicates.</p>
<div class="section level3">
<h3 id="general-strategy">General Strategy<a class="anchor" aria-label="anchor" href="#general-strategy"></a>
</h3>
<p>While there are many rule-of-thumb values for the number of
replicates that should be used (some say 500, others say 1,000), it is
advisable to instead use a principled strategy for choosing the number
of replicates. One general strategy proposed by <span class="citation">Beaumont and Patak (2012)</span> is as follows:</p>
<ul>
<li><p><strong>Step 1</strong>: Determine the largest acceptable level
of simulation error for key survey estimates. For example, one might
determine that, on average, the bootstrap standard error estimate should
be no more than <span class="math inline">\(\pm 5\%\)</span> different
than the ideal bootstrap estimate.</p></li>
<li><p><strong>Step 2</strong>: Estimate key statistics of interest
using a large number of bootstrap replicates (such as 5,000) and save
the estimates from each bootstrap replicate. This can be conveniently
done using a function from the ‘survey’ package such as
<code>svymean(..., return.replicates = TRUE)</code> or
<code>withReplicates(..., return.replicates = TRUE)</code>.</p></li>
<li><p><strong>Step 3</strong>: Estimate the minimum number of bootstrap
replicates needed to reduce the level of simulation error to the target
level. This can be done using the ‘svrep’ function
<code><a href="../reference/estimate_boot_reps_for_target_cv.html">estimate_boot_reps_for_target_cv()</a></code>.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="measuring-and-estimating-simulation-error">Measuring and Estimating Simulation Error<a class="anchor" aria-label="anchor" href="#measuring-and-estimating-simulation-error"></a>
</h3>
<p>Simulation error can be measured as a <strong>“simulation coefficient
of variation” (CV)</strong>, which is the ratio of the standard error of
a bootstrap estimator to the expectation of that bootstrap estimator,
where the expectation and standard error are evaluated with respect to
the bootstrapping process given the selected sample.</p>
<p>For a statistic <span class="math inline">\(\hat{\theta}\)</span>,
the simulation CV of the bootstrap variance estimator <span class="math inline">\(v_{B}(\hat{\theta})\)</span> based on <span class="math inline">\(B\)</span> replicate estimates <span class="math inline">\(\hat{\theta}^{\star}_1,\dots,\hat{\theta}^{\star}_B\)</span>
is defined as follows:</p>
<span class="math display">\[\begin{aligned}

    CV_{\star}(v_{B}(\hat{\theta})) &amp;=
\frac{\sqrt{var_{\star}(v_B(\hat{\theta}))}}{E_{\star}(v_B(\hat{\theta}))}
= \frac{CV_{\star}(E_2)}{\sqrt{B}} \\
    \textit{where:}&amp; \\
    E_2 &amp;= (\hat{\theta}^{\star} - \hat{\theta})^2 \\
    CV_{\star}(E_2) &amp;=
\frac{\sqrt{var_{\star}(E_2)}}{E_{\star}(E_2)} \\
    \textit{and }&amp; var_{\star} \text{ and } E_{\star} \textit{ are
evaluated} \\
    &amp; \textit{with respect to the bootstrapping process} \\
    &amp; \textit{given the selected sample}
\end{aligned}\]</span>
<p>The simulation CV of a statistic, denoted <span class="math inline">\(CV_{\star}(v_{B}(\hat{\theta}))\)</span>, can be
estimated for a given number of replicates <span class="math inline">\(B\)</span> by estimating <span class="math inline">\(CV_{\star}(E_2)\)</span> using observed values and
dividing this by <span class="math inline">\(\sqrt{B}\)</span>. As a
result, one can thereby estimate the number of bootstrap replicates
needed to obtain a target simulation CV, which is a useful strategy for
determining the number of bootstrap replicates to use for a survey.</p>
<p>With the ‘svrep’ package, it is possible to estimate the number of
bootstrap replicates required to obtain a target simulation CV for a
statistic.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'api'</span>, package <span class="op">=</span> <span class="st">'survey'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Declare a bootstrap survey design object ----</span></span>
<span>  <span class="va">boot_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">apistrat</span>,</span>
<span>    weights <span class="op">=</span> <span class="op">~</span><span class="va">pw</span>,</span>
<span>    id <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>    strata <span class="op">=</span> <span class="op">~</span><span class="va">stype</span>,</span>
<span>    fpc <span class="op">=</span> <span class="op">~</span><span class="va">fpc</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">svrep</span><span class="fu">::</span><span class="fu"><a href="../reference/as_bootstrap_design.html">as_bootstrap_design</a></span><span class="op">(</span>replicates <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Produce estimates of interest, and save the estimate from each replicate ----</span></span>
<span>  <span class="va">estimated_means_and_proportions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span> <span class="va">api00</span> <span class="op">+</span> <span class="va">api99</span> <span class="op">+</span> <span class="va">stype</span>,</span>
<span>                                             design <span class="op">=</span> <span class="va">boot_design</span>,</span>
<span>                                             return.replicates <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the number of replicates needed to obtain a target simulation CV ----</span></span>
<span>  <span class="fu"><a href="../reference/estimate_boot_reps_for_target_cv.html">estimate_boot_reps_for_target_cv</a></span><span class="op">(</span></span>
<span>    svrepstat <span class="op">=</span> <span class="va">estimated_means_and_proportions</span>,</span>
<span>    target_cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt;   TARGET_CV MAX_REPS api00 api99 stypeE stypeH stypeM</span></span>
<span><span class="co">#&gt; 1      0.01    15068  6651  6652  15068  15068  15068</span></span>
<span><span class="co">#&gt; 2      0.05      603   267   267    603    603    603</span></span>
<span><span class="co">#&gt; 3      0.10      151    67    67    151    151    151</span></span></code></pre></div>
<p>To estimate the simulation CV for the current number of replicates
used, it is possible to use the function
<code><a href="../reference/estimate_boot_sim_cv.html">estimate_boot_sim_cv()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/estimate_boot_sim_cv.html">estimate_boot_sim_cv</a></span><span class="op">(</span><span class="va">estimated_means_and_proportions</span><span class="op">)</span></span>
<span><span class="co">#&gt;   STATISTIC SIMULATION_CV N_REPLICATES</span></span>
<span><span class="co">#&gt; 1     api00    0.01153322         5000</span></span>
<span><span class="co">#&gt; 2     api99    0.01153350         5000</span></span>
<span><span class="co">#&gt; 3    stypeE    0.01735956         5000</span></span>
<span><span class="co">#&gt; 4    stypeH    0.01735950         5000</span></span>
<span><span class="co">#&gt; 5    stypeM    0.01735951         5000</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-bootstrap-vs--other-replication-methods">The Bootstrap vs. Other Replication Methods<a class="anchor" aria-label="anchor" href="#the-bootstrap-vs--other-replication-methods"></a>
</h2>
<blockquote>
<p>Far better an approximate answer to the right question, which is
often vague, than the exact answer to the wrong question, which can
always be made precise.</p>
<p>-- John Tukey</p>
<p>Ok, but what if the approximate answer is, like, <em>really</em>
approximate or requires a whole lot of computing?</p>
<p>-- Survey sampling statisticians</p>
</blockquote>
<p>Survey bootstrap methods are directly applicable to a wider variety
of sample designs than the jackknife or balanced repeated replication
(BRR). Nonetheless, complex survey designs are often shoehorned into
jackknife or BRR variance estimation by pretending that the actual
survey design was something simpler. The BRR method, for instance, is
only applicable to samples with two clusters sampled from each stratum,
but statisticians frequently use it for designs with three or more
sampled clusters by grouping the actual clusters into two
pseudo-clusters. For designs with a large number of sampling units in a
stratum, the exact jackknife (JK1 or JKn) requires a large number of
replicates and so is often replaced by the “delete-a-group jackknife”
(DAGJK) with clusters randomly grouped into larger pseudo-clusters.</p>
<p>Why do statisticians go to all this effort to shoehorn their variance
estimation problem into jackknife or BRR methods when they could just
use the bootstrap?</p>
<p>The simple answer is that bootstrap methods generally require many
more replicates than other methods in order to obtain a stable variance
estimate. And using a large number of replicates can be a problem if you
have to do a large amount of computing or if your dataset is large and
you’re concerned about storage costs. Statistical agencies are
particularly sensitive to these concerns when they publish microdata,
since agencies often serve a large number of end-users with varying
computational resources.</p>
<p><strong>So why use the bootstrap?</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>The bootstrap tends to works well for a larger class of
statistics than the jackknife.</strong> For example, for estimating the
sampling variance of an estimated median or other quantiles, the
jackknife tends to perform poorly but bootstrap methods at least do an
adequate job.</p></li>
<li><p><strong>Bootstrap methods enable different options for forming
confidence intervals.</strong> For all of the standard replication
methods (BRR, Jackknife, etc.), confidence intervals are generally
formed using a Wald interval (<span class="math inline">\(\hat{\theta}
\pm \hat{se}(\hat{\theta}) \times z_{1-\frac{\alpha}{2}}\)</span>).<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Non-Wald methods are typically only used in practice for
confidence intervals for proportions. These non-Wald methods are
normally based on the point estimate, the standard error, and a measure
of effective sample size.&lt;/p&gt;"><sup>2</sup></a> But for
certain bootstrap methods, it is possible to also form confidence
intervals using other approaches, such as the bootstrap percentile
method.</p></li>
<li>
<p><strong>You can analyze your design rather than an approximation
of your design, which can both reduce costs and better control
errors</strong>. To use BRR for general survey designs, you have to
approximate your actual survey design with a “two PSUs per stratum”
design. This works surprisingly well in many cases, but it requires
careful work on the part of a specially-trained statistician. For the
jackknife with a large number of sampling units, you either end up with
the same number of replicates as a bootstrap method or you have to
randomly group your sampling units into a smaller number so you can use
the DAGJK method to essentially approximate your actual survey design
with a simpler one. Again, this takes careful work on the part of a
specially-trained statistician.</p>
<ol style="list-style-type: decimal">
<li><p>By analyzing your design for what it is, <strong>you don’t have
to pay a specially-trained statistician to meticulously approximate a
design so that it can be shoehorned into a jackknife or BRR variance
estimation problem</strong>, which is perhaps not the best use of a
limited budget.</p></li>
<li><p><strong>If the variance estimation is based on a bootstrap method
tailored to the actual survey design, then the replication error in the
variance estimates for key statistics is unbiased and can be quantified
and controlled as a function of the number of replicates</strong>. In
contrast, when variance estimation is based on approximating a design so
that it can be shoehorned into a jackknife or BRR variance estimation
problem, then the replication error in the variance estimates is more
difficult to quantify and can consist of both noise and bias.</p></li>
</ol>
</li>
<li><p><strong>For most statisticians, it’s probably easier to
learn.</strong> The bootstrap is the most well-known replication method
among general statisticians, to the point that it’s often taught in
first-year undergraduate statistics courses. So the basic idea is
already familiar even to statisticians with only passing familiarity
with complex survey sampling. BRR, in contrast, takes specialized
training to learn and entails pre-requisite concepts such as Hadamard
matrices, partial balancing, and so on. Outside of survey statistics,
the jackknife tends to be much less used (and taught) compared to the
bootstrap, due to its limitations with non-smooth statistics and the
complexity required to make it work efficiently for large sample
sizes.</p></li>
</ol>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ash2014" class="csl-entry">
Ash, Stephen. 2014. <span>“Using Successive Difference Replication for
Estimating Variances.”</span> <em>Survey Methodology, Statistics
Canada</em> 40 (1): 47–59. <a href="https://www150.statcan.gc.ca/n1/pub/12-001-x/12-001-x2014001-eng.pdf" class="external-link">https://www150.statcan.gc.ca/n1/pub/12-001-x/12-001-x2014001-eng.pdf</a>.
</div>
<div id="ref-beaumont2022" class="csl-entry">
Beaumont, Jean-François, and Nelson Émond. 2022. <span>“A Bootstrap
Variance Estimation Method for Multistage Sampling and Two-Phase
Sampling When Poisson Sampling Is Used at the Second Phase.”</span>
<em>Stats</em> 5 (2): 339–57. <a href="https://doi.org/10.3390/stats5020019" class="external-link">https://doi.org/10.3390/stats5020019</a>.
</div>
<div id="ref-beaumont2012" class="csl-entry">
Beaumont, Jean-François, and Zdenek Patak. 2012. <span>“On the
Generalized Bootstrap for Sample Surveys with Special Attention to
Poisson Sampling: <span><em>Generalized Bootstrap for Sample
Surveys</em></span>.”</span> <em>International Statistical Review</em>
80 (1): 127–48. <a href="https://doi.org/10.1111/j.1751-5823.2011.00166.x" class="external-link">https://doi.org/10.1111/j.1751-5823.2011.00166.x</a>.
</div>
<div id="ref-bertail1997" class="csl-entry">
Bertail, and Combris. 1997. <span>“Bootstrap Généralisé d’un
Sondage.”</span> <em>Annales d’Économie Et de Statistique</em>, no. 46:
49. <a href="https://doi.org/10.2307/20076068" class="external-link">https://doi.org/10.2307/20076068</a>.
</div>
<div id="ref-dippo1984" class="csl-entry">
Dippo, Cathryn, Robert Fay, and David Morganstein. 1984.
<span>“Computing Variances from Complex Samples with Replicate
Weights.”</span> In, 489–94. Alexandria, VA: American Statistical
Association. <a href="http://www.asasrms.org/Proceedings/papers/1984_094.pdf" class="external-link">http://www.asasrms.org/Proceedings/papers/1984_094.pdf</a>.
</div>
<div id="ref-fay1984" class="csl-entry">
Fay, Robert. 1984. <span>“Some Properties of Estimates of Variance Based
on Replication Methods.”</span> In, 495–500. Alexandria, VA: American
Statistical Association. <a href="http://www.asasrms.org/Proceedings/papers/1984_095.pdf" class="external-link">http://www.asasrms.org/Proceedings/papers/1984_095.pdf</a>.
</div>
<div id="ref-mashreghi2016" class="csl-entry">
Mashreghi, Zeinab, David Haziza, and Christian Léger. 2016. <span>“A
Survey of Bootstrap Methods in Finite Population Sampling.”</span>
<em>Statistics Surveys</em> 10 (none). <a href="https://doi.org/10.1214/16-SS113" class="external-link">https://doi.org/10.1214/16-SS113</a>.
</div>
<div id="ref-sarndalModelAssistedSurvey1992" class="csl-entry">
Särndal, Carl-Erik, Bengt Swensson, and Jan Wretman. 1992. <em>Model
<span>Assisted Survey Sampling</span></em>. Springer <span>Series</span>
in <span>Statistics</span>. <span>New York, NY</span>: <span>Springer
New York</span>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Schneider.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
